<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Threat Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
   h1 {
  color: #ffd700; /* Ø°Ù‡Ø¨ÙŠ Ù„Ø§Ù…Ø¹ */
  margin-bottom: 20px;
  font-size: 28px;
}

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, select, button {
      background: #161b22;
      color: #ffffff;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 14px;
    }
    .table-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #30363d;
    }
   th {
  background-color: #222;       /* ØºØ§Ù…Ù‚ Ø£ÙƒØ«Ø± Ù„ÙŠØ¨Ø±Ø² Ø§Ù„Ø°Ù‡Ø¨ */
  color: #ffd700;               /* Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ Ù„Ø§Ù…Ø¹ */
  font-weight: bold;
  font-size: 16px;
}


td {
  color: #ffffff;      /* Ø§Ù„Ù†Øµ Ø£Ø¨ÙŠØ¶ */
  padding: 12px 10px;
  border: 1px solid #333;
  font-size: 15px;
}


    tr:nth-child(even) {
      background-color: #1f2937;
    }

    #threatChart {
      max-width: 100%;
      margin-bottom: 40px;
    }

    form {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      cursor: pointer;
      background-color: #238636;
      color: white;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #2ea043;
    }

    .icon {
      color: #58a6ff;
      margin-right: 5px;
    }

    @media (max-width: 600px) {
      .filters, form {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>

  <h1><i class="fas fa-shield-alt icon"></i> Threat Monitoring Dashboard</h1>

  <div class="filters">
    <input type="text" id="filterIP" placeholder="ðŸ” Filter by IP">
    <select id="filterType">
      <option value="">All Threats</option>
      <option value="malware detected">Malware</option>
      <option value="scan attempt">Scan</option>
      <option value="attack vector">Attack</option>
    </select>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>IP Address</th>
          <th>Method</th>
          <th>Threat Type</th>
        </tr>
      </thead>
      <tbody id="logTableBody"></tbody>
    </table>
  </div>

  <canvas id="threatChart" height="120"></canvas>

  <h3 style="margin-top: 20px;">Add Fake Threat</h3>
  <form id="addForm">
    <input type="text" name="ip" placeholder="IP" required>
    <select name="method"><option>GET</option><option>POST</option></select>
    <select name="type">
      <option value="malware detected">Malware</option>
      <option value="scan attempt">Scan</option>
      <option value="attack vector">Attack</option>
    </select>
    <button type="submit"><i class="fas fa-plus-circle icon"></i> Add</button>
  </form>

  <script>
    let allLogs = [];
    let chartRef = null;

    async function fetchCSVFromGitHub() {
      const baseUrl = 'https://corsproxy.io/?https://raw.githubusercontent.com/etiqotwf/liveServer1/main/public/logs/threats.csv';
      const nocacheUrl = `${baseUrl}?_=${Date.now()}`;
      try {
        const response = await fetch(nocacheUrl, { cache: "no-store" });
        const text = await response.text();

        if (text.includes('<html') || text.includes('There isn\'t a GitHub Pages site')) return [];

        const rows = text.trim().split('\n').slice(1);
        return rows.map(row => {
          const [timestamp, ip, method, threatType] = row.split(',');
          return { timestamp, ip, method, threatType };
        });
      } catch (error) {
        console.error('âŒ Error loading CSV:', error);
        return [];
      }
    }

    function filterLogs(logs) {
      const ipFilter = document.getElementById('filterIP').value.trim();
      const typeFilter = document.getElementById('filterType').value;
      return logs.filter(log =>
        (!ipFilter || log.ip.includes(ipFilter)) &&
        (!typeFilter || log.threatType === typeFilter)
      );
    }

    function renderTable(logs) {
      const tbody = document.getElementById('logTableBody');
      tbody.innerHTML = '';
      logs.forEach(log => {
        tbody.innerHTML += `<tr>
          <td>${log.timestamp}</td>
          <td>${log.ip}</td>
          <td>${log.method}</td>
          <td>${log.threatType}</td>
        </tr>`;
      });
    }

    function drawThreatChart(logs) {
      const filtered = filterLogs(logs);
      const threatCounts = {};
      filtered.forEach(t => {
        threatCounts[t.threatType] = (threatCounts[t.threatType] || 0) + 1;
      });

      const labels = Object.keys(threatCounts);
      const dataValues = Object.values(threatCounts);
      const ctx = document.getElementById('threatChart').getContext('2d');

      if (chartRef) chartRef.destroy();

      chartRef = new Chart(ctx, {
  type: 'bar',
  data: {
    labels,
    datasets: [{
      label: 'Threat Count',
      data: dataValues,
      backgroundColor: ['#d32f2f', '#fbc02d', '#1976d2'],
      borderRadius: 8
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false, // âœ… Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù…Ù‡Ù…
    plugins: {
      legend: { labels: { color: '#fff' } },
      title: {
        display: true,
        text: 'Threat Type Statistics',
        color: '#58a6ff'
      }
    },
    scales: {
      x: { ticks: { color: '#ccc' }, grid: { display: false } },
      y: { beginAtZero: true, ticks: { color: '#ccc' }, grid: { color: '#333' } }
    }
  }
});

    async function updateDashboard() {
      const logs = await fetchCSVFromGitHub();
      allLogs = logs;
      renderTable(filterLogs(allLogs));
      drawThreatChart(allLogs);
    }

    document.getElementById('filterIP').addEventListener('input', () => {
      renderTable(filterLogs(allLogs));
      drawThreatChart(allLogs);
    });

    document.getElementById('filterType').addEventListener('change', () => {
      renderTable(filterLogs(allLogs));
      drawThreatChart(allLogs);
    });

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const newThreat = {
        ip: form.ip.value,
        method: form.method.value,
        threatType: form.type.value
      };

      const res = await fetch('/api/add-threat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newThreat)
      });

      if (res.ok) {
        form.reset();
        updateDashboard();
      } else {
        alert('âŒ Failed to send threat to server.');
      }
    });

    updateDashboard();


document.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      console.error(`Error attempting fullscreen: ${err.message}`);
    });
  }
});


  </script>
</body>
</html>
