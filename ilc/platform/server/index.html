<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>EduPlatform</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --main:#6a1b9a;
  --light:#f5f5f5;
  --dark:#222;
}
*{box-sizing:border-box;font-family:Segoe UI,Tahoma}
body{margin:0;background:var(--light);direction:rtl}

/* Header */
#topBar{display:none}
header{
  background:#fff;
  padding:15px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
header h1{color:var(--main)}
header button{
  background:var(--main);
  color:#fff;
  border:none;
  padding:8px 16px;
  border-radius:6px;
  cursor:pointer;
}

/* Landing */
#landing{text-align:center;padding:80px 20px}
#landing h2{font-size:36px}
#landing p{font-size:18px;color:#555}
#landing button{padding:14px 30px;font-size:18px}

/* Login */
#login{
  display:none;
  min-height:100vh;
  justify-content:center;
  align-items:center;
}
.login-box{
  background:#fff;
  padding:40px;
  width:360px;
  border-radius:12px;
  box-shadow:0 15px 40px rgba(0,0,0,.15);
  text-align:center;
}
.login-box input{
  width:100%;
  padding:12px;
  margin-bottom:15px;
}
.login-box button{width:100%;padding:12px}

/* App */
#app{display:none}
main{display:grid;grid-template-columns:260px 1fr}
aside{background:#fff;padding:15px}
.course{border:1px solid #ddd;border-radius:8px;margin-bottom:15px;overflow:hidden}
.course img{width:100%;height:120px;object-fit:cover}
.course div{padding:10px}
section{padding:20px}
.lesson{background:#eee;padding:10px;margin-bottom:8px;cursor:pointer}
.lesson.done{background:#c8e6c9}
video{width:100%;margin-top:10px}
.admin{background:#fff;padding:15px;margin-top:20px}
</style>
</head>

<body>

<div id="topBar">
<header>

  <h1>ILC Platform</h1>

  <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</header>
</div>

<div id="landing">


<!-- Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø®Ù„Ù Ø§Ù„Ù†Øµ -->
<img src="ilc.jpg" alt="ILC Logo" style="
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 900px;       /* Ø­Ø¬Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© */
  opacity: 0.1;       /* Ø§Ù„Ø´ÙØ§ÙÙŠØ© */
  pointer-events: none;
  user-select: none;
  z-index: 0; /* Ø®Ù„Ù Ø§Ù„Ù†ØµÙˆØµ Ù„ÙƒÙ† ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© */
">
  <h2> Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯ÙˆÙ„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ·Ø§Ù†Ù‰ Ø¨Ø·Ù†Ø·Ø§</h2>
  <h2>Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h2>
  <h2>ØªØ¹Ù„Ù… Ø£ÙŠ Ø´ÙŠØ¡ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª</h2>
  <button onclick="showLogin()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
</div>

<div id="login">
  <div class="login-box">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="u" placeholder="teacher / student">
    <input id="p" type="password" placeholder="123">
    <button onclick="loginUser()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<div id="app">
<main>

<aside>
  <select onchange="filterCourses(this.value)" style="width:100%;padding:10px;margin-bottom:15px">
    <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
    <option value="Programming">Programming</option>
    <option value="AI">AI</option>
    <option value="Design">Design</option>
  </select>

  <div id="courses"></div>
</aside>

<section>
  <h2 id="courseTitle">Ø§Ø®ØªØ± ÙƒÙˆØ±Ø³</h2>

<video id="liveVideo" autoplay playsinline></video>
<button onclick="startLive()">Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>

  <video id="video" controls></video>
  <div id="chatBox" style="margin-top:20px">
  <div id="messages" style="height:200px;overflow:auto;background:#fff;padding:10px"></div>
  <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="width:80%">
  <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

  <div id="lessons"></div>
  <div id="admin"></div>
</section>

</main>
</div>

<script src="http://localhost:3000/socket.io/socket.io.js"></script>

<script>


const socket = io();

function sendMessage(){
  if(!current) return alert("Ø§Ø®ØªØ± ÙƒÙˆØ±Ø³ Ø£ÙˆÙ„Ù‹Ø§");

  const msg = msgInput.value.trim();
  if(!msg) return;

  socket.emit("sendMessage", {
    courseId: current.id,
    user: user.role,
    text: msg
  });

  msgInput.value="";
}

socket.on("newMessage", data => {
  messages.innerHTML += `
    <div style="
      margin-bottom:6px;
      color:${data.user==="teacher" ? "#6a1b9a" : "#000"};
      font-weight:${data.user==="teacher" ? "bold" : "normal"};
    ">
      ${data.user}: ${data.text}
    </div>
  `;
});


/* ==============================
   ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
================================ */
document.addEventListener("click", () => {
  const elem = document.documentElement;
  if (document.fullscreenElement) return;

  if (elem.requestFullscreen) elem.requestFullscreen();
  else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
  else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
});

/* ==============================
   Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
================================ */
const landing = document.getElementById("landing");
const loginBox = document.getElementById("login");
const app = document.getElementById("app");
const topBar = document.getElementById("topBar");

const u = document.getElementById("u");
const p = document.getElementById("p");

const coursesBox = document.getElementById("courses");
const lessonsBox = document.getElementById("lessons");
const courseTitle = document.getElementById("courseTitle");
const video = document.getElementById("video");
const admin = document.getElementById("admin");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");

/* ==============================
   Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
================================ */
let user = null;
let current = null;
let db = null;
let viewMode = "details"; // details | player
let localStream;

async function startLive(){
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById("liveVideo").srcObject = localStream;

  socket.emit("startLive", current.id);
}


/* ==============================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
================================ */
function showLogin(){
  landing.style.display = "none";
  loginBox.style.display = "flex";
}

function loginUser(){
  if(u.value === "teacher" && p.value === "123"){
    localStorage.user = JSON.stringify({ role:"teacher" });
  }else if(u.value === "student" && p.value === "123"){
    localStorage.user = JSON.stringify({ role:"student" });
  }else{
    alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    return;
  }
  location.reload();
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* ==============================
   Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
================================ */
const userRaw = localStorage.getItem("user");
if(!userRaw){
  landing.style.display = "block";
}else{
  user = JSON.parse(userRaw);
  landing.style.display = "none";
  loginBox.style.display = "none";
  app.style.display = "block";
  topBar.style.display = "block";
}


function joinChatRoom(){
  socket.emit("joinRoom", current.id);
}


/* ==============================
   IndexedDB
================================ */
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open("EduPlatform",1);

    req.onerror = ()=>reject("ÙØ´Ù„ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    req.onsuccess = ()=>{
      db = req.result;
      resolve(db);
    };

    req.onupgradeneeded = e=>{
      db = e.target.result;
      if(!db.objectStoreNames.contains("courses")){
        const store = db.createObjectStore("courses",{keyPath:"id",autoIncrement:true});
        store.createIndex("title","title",{unique:false});

        store.transaction.oncomplete = ()=>{
          const s = db.transaction("courses","readwrite").objectStore("courses");
          s.add({
            title:"JavaScript Basics",
            category:"Programming",
            price:25,
            discount:20,
            rate:4.8,
            img:"https://picsum.photos/400/200",
            published:true,
            lessons:[
              {
                title:"Intro",
                video:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
              }
            ],
            quiz:[]
          });
        };
      }
    };
  });
}

function getAllCourses(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction("courses","readonly");
    const store = tx.objectStore("courses");
    const req = store.getAll();
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject();
  });
}

function addCourseToDB(course){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction("courses","readwrite");
    const store = tx.objectStore("courses");
    const req = store.add(course);
    req.onsuccess = ()=>resolve();
    req.onerror = ()=>reject();
  });
}

function updateCourseInDB(course){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction("courses","readwrite");
    const store = tx.objectStore("courses");
    const req = store.put(course);
    req.onsuccess = ()=>resolve();
    req.onerror = ()=>reject();
  });
}

function deleteCourseInDB(id){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction("courses","readwrite");
    const store = tx.objectStore("courses");
    const req = store.delete(id);
    req.onsuccess = ()=>resolve();
    req.onerror = ()=>reject();
  });
}

/* ==============================
   Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
================================ */
async function loadCourses(filter="all"){
  coursesBox.innerHTML = "";

  if(user.role === "teacher"){
    coursesBox.innerHTML += `
      <button style="width:100%;padding:12px;margin-bottom:15px"
        onclick="promptAddCourse()">â• Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³</button>
    `;
  }

  const courses = await getAllCourses();
  courses
    .filter(c=>filter==="all"||c.category===filter)
    .forEach(renderCourse);
}

function renderCourse(c){
  const price = c.discount ? Math.round(c.price - (c.price*c.discount/100)) : c.price;
  coursesBox.innerHTML += `
    <div class="course">
      <img src="${c.img}">
      <div>
        <h4>${c.title}</h4>
        <small>${c.category}</small><br>
        â­ ${c.rate || "Ø¬Ø¯ÙŠØ¯"}<br>
        <b>$${price}</b>
        <button onclick="loadCourse(${c.id})">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  `;
}

/* ==============================
   ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³
================================ */
async function loadCourse(id){
  const courses = await getAllCourses();
  current = courses.find(c=>c.id===id);
  viewMode = "details";

  lessonsBox.innerHTML = "";
  admin.innerHTML = "";
  video.src = "";

  courseTitle.innerHTML = `
    <h2>${current.title}</h2>
    <p>Ø§Ù„Ù‚Ø³Ù…: ${current.category}</p>
    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³: ${current.lessons.length}</p>
    <button onclick="startCourse()"
      style="padding:12px 25px;background:var(--main);color:#fff;border:none;border-radius:8px">
      Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ù„Ù…
    </button>
  `;
}

/* ==============================
   ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³
================================ */
function startCourse(){
  joinChatRoom();   // âœ… Ø´Ø§Øª
  logAttendance();  // âœ… Ø­Ø¶ÙˆØ±  viewMode = "player";
  courseTitle.innerText = current.title;
  lessonsBox.innerHTML = "";
  video.src = "";

  current.lessons.forEach((l,idx)=>{
    const d = document.createElement("div");
    d.className = "lesson";
    d.innerText = l.title;

    if(user.role==="teacher"){
      const del = document.createElement("button");
      del.innerText="ğŸ—‘ï¸";
      del.onclick=e=>{
        e.stopPropagation();
        deleteLesson(idx);
      };
      d.prepend(del);
    }

    d.onclick=()=>{
      video.src = l.video;
      d.classList.add("done");
    };

    lessonsBox.appendChild(d);
  });

  if(user.role==="teacher"){
    admin.innerHTML = `
      <div class="admin">
        <button onclick="promptAddLesson()">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³</button>
        <button onclick="promptDeleteCourse()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³</button>
      </div>
    `;
  }
}

function logAttendance(){
  const log = JSON.parse(localStorage.att || "[]");
  log.push({
    courseId: current.id,
    time: new Date().toISOString()
  });
  localStorage.att = JSON.stringify(log);
}


function showAttendance(){
  const log = JSON.parse(localStorage.att || "[]");
  console.table(log.filter(l=>l.courseId===current.id));
}


/* ==============================
   Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
================================ */
async function promptAddCourse(){
  const title = prompt("Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³");
  const category = prompt("Ø§Ù„Ù‚Ø³Ù…");
  const price = Number(prompt("Ø§Ù„Ø³Ø¹Ø±"));
  if(!title||!category||isNaN(price)) return;

  await addCourseToDB({
    title,category,price,
    discount:0,rate:0,
    img:"https://picsum.photos/400/200",
    lessons:[],quiz:[]
  });
  loadCourses();
}

async function promptAddLesson(){
  const t = prompt("Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³");
  const v = prompt("Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
  if(!t||!v) return;

  current.lessons.push({title:t,video:v});
  await updateCourseInDB(current);
  startCourse();
}

async function deleteLesson(idx){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³ØŸ")) return;
  current.lessons.splice(idx,1);
  await updateCourseInDB(current);
  startCourse();
}

async function promptDeleteCourse(){
  if(!confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
  await deleteCourseInDB(current.id);
  courseTitle.innerText="Ø§Ø®ØªØ± ÙƒÙˆØ±Ø³";
  lessonsBox.innerHTML="";
  video.src="";
  admin.innerHTML="";
  loadCourses();
}

/* ==============================
   ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
================================ */
(async()=>{
  await openDB();
  if(user) loadCourses();
})();



</script>

</body>
</html>
