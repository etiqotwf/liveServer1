<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</title>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
<script src="xlsx.full.min.js"></script>
<script src="chart.js"></script>

<style>
/* ====== Ø¹Ø§Ù… ====== */

body {
  font-family: 'Cairo', "Segoe UI", Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg, #1e1e2f, #2c3e50);
  color: #fff;
  margin: 0;
  padding: 20px;
  direction: rtl;
}

.container {
  width: 95%;
  max-width: 1200px;
  margin: auto;
  background: #1f2937;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.container:hover {
  transform: translateY(-5px);
  box-shadow: 0 16px 60px rgba(0,0,0,0.6);
}

/* ====== Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ====== */
h2 {
  text-align: center;
  font-size: 40px;
  font-weight: 900;
  color: #ff7f50; /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
  margin: 15px 0 25px 0;
  letter-spacing: 1px;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
}

@media (max-width: 768px) {
  h2 {
    font-size: 32px;
  }
}

/* ====== Ø§Ù„ÙÙˆØ±Ù… ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ====== */
input, select, button {
  font-family: inherit;
  font-size: 20px;
  padding: 12px 16px;
  border-radius: 12px;
  border: none;
  outline: none;
  transition: all 0.3s ease;
}

input:focus, select:focus {
  box-shadow: 0 0 12px #ff7f50;
  border: 1px solid #ff7f50;
}

/* ====== Ø£Ø²Ø±Ø§Ø± ====== */
button {
  cursor: pointer;
  font-weight: 900;
  border-radius: 12px;
  padding: 14px 28px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  text-transform: uppercase;
}

button:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.btn-primary {
  background: linear-gradient(45deg, #ff7f50, #ff6347);
  color: #fff;
}

.btn-primary:hover {
  background: linear-gradient(45deg, #ff6347, #ff4500);
}

.btn-danger {
  background: linear-gradient(45deg, #ff4d4d, #ff1a1a);
  color: #fff;
}

.btn-danger:hover {
  background: linear-gradient(45deg, #ff1a1a, #cc0000);
}

#traineesTable {
  display: none;
  margin-top: 35px;
  overflow-x: auto;
  border-radius: 16px;
  box-shadow: 0 12px 36px rgba(0,0,0,0.5);
  background: #ffffff; /* Ù‡Ù†Ø§ ØºÙŠØ±Ù†Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù„Ø§Ø¨ÙŠØ¶ */
  padding: 25px;
  color: #1c1c1c; /* Ù†Øµ Ø¯Ø§ÙƒÙ† Ù„Ù„ÙˆØ¶ÙˆØ­ */
}

#traineesTable h3 {
  text-align: center;
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 20px;
  color: #ff7f50; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
  text-shadow: none; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¸Ù„ Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨ÙŠØ¶ */
}

#traineesTable th {
  background: #1e3a8a; /* ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ */
  color: #ffffff;       /* Ù†Øµ Ø£Ø¨ÙŠØ¶ ÙˆØ§Ø¶Ø­ */
  font-weight: 800;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3); /* ØªØ£Ø«ÙŠØ± Ø¨Ø±ÙˆØ² Ø®ÙÙŠÙ Ù„Ù„Ù†Øµ */
  box-shadow: inset 0 -3px 6px rgba(255,255,255,0.2); /* ØªØ£Ø«ÙŠØ± Ø¨Ø±ÙˆØ² Ø¯Ø§Ø®Ù„ÙŠ */
  border-bottom: 2px solid #0f1f5e; /* Ø®Ø· ÙØ§ØµÙ„ ÙŠØ¨Ø±Ø² Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
}



#traineesTable td {
  background: #ffffff; /* ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø¨Ø§Ù„Ø§Ø¨ÙŠØ¶ */
  color: #1c1c1c; /* Ù†Øµ Ø¯Ø§ÙƒÙ† Ù„Ù„ÙˆØ¶ÙˆØ­ */
  font-weight: 600;
    font-weight: bold;   /* ÙƒÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø¨ÙˆÙ„Ø¯ */
      font-size: 19px;     /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· */


}



/* ====== Ø§Ù„Ø¨Ø­Ø« ====== */
.search-bar {
  display: flex;
  justify-content: center;
  margin: 25px 0;
  gap: 0;
}

#searchInput {
  flex: 1;
  max-width: 400px;
  border-radius: 12px 0 0 12px;
  font-size: 20px;
  padding: 12px;
}

#searchBtn {
  border-radius: 0 12px 12px 0;
  background: #ff7f50;
  color: #fff;
  font-weight: 900;
  font-size: 18px;
}

/* ====== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ====== */
.buttons-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin-bottom: 20px;
}

/* responsive */
@media (max-width: 768px) {
  .buttons-row {
    flex-direction: column;
  }

  #searchInput {
    width: 70%;
  }

  #searchBtn {
    width: 30%;
  }
}

/* ====== Fullscreen effect ====== */
html, body {
  height: 100%;
}
</style>

</head>
<body>

<div class="container">
  <h2>British International Learning Center (ILC)</h2>
  <h2>ğŸ”¹ Trainees Database Management Quiz Form </h2>

  <!-- Search -->
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¯ÙˆØ±Ø©ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ...">
    <button id="searchBtn" onclick="searchTrainees()" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button>
  </div>

  <!-- Buttons -->
  <div class="buttons-row">
    <button class="btn btn-primary" onclick="backupIndexedDB()">ğŸ”„ Backup</button>
    <button class="btn btn-primary" onclick="document.getElementById('restoreFile').click()">â™»ï¸ Restore</button>
    <input type="file" id="restoreFile" style="display:none;" onchange="restoreIndexedDB(event)" accept=".json" />
    <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ Refresh</button>
    <button class="btn btn-primary" onclick="toggleAllTrainees()">ğŸ–¨ï¸ Print</button>
  </div>

  <!-- Table -->
  <div id="traineesTable">
    <h3>ğŸ§‘â€ğŸ“ğŸ“Š Search Trainees Table</h3>
    <table id="allTrainees">
      <thead>
        <tr>
          <th>ğŸ•’ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
          <th>ğŸ“ Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
          <th>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</th>
          <th>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>â° ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡</th>
          <th>â³ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø³ØªØºØ±Ù‚Ø©</th>
          <th>ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
          <th>ğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨</th>
          <th>ğŸ—‘ï¸ Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>





<script>
  // Fullscreen on click
  document.addEventListener("click", () => {
    const elem = document.documentElement;
    if (!document.fullscreenElement) {
      elem.requestFullscreen?.() || elem.webkitRequestFullscreen?.() || elem.msRequestFullscreen?.();
    }
  });
</script>

</body>
</html>



  <script>
  let db;

function syncWithGoogleSheets() {
  const txCheck = db.transaction("trainees", "readonly");
  const storeCheck = txCheck.objectStore("trainees");

  const countRequest = storeCheck.count();

  countRequest.onsuccess = function () {
    const count = countRequest.result;
    const lastIndex = (count === 0) ? 0 : (parseInt(localStorage.getItem("lastSyncedIndex")) || 0);

    fetch(`https://script.google.com/macros/s/AKfycbybhyNx3uPAoAjGlvHe_jumSp_NKeOIIwoAPHWOqzUukmlmtoTlE5wF8Y_w17l5m9FS/exec`)
      .then(response => response.json())
      .then(data => {
        if (!Array.isArray(data)) {
          console.error("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
          return;
        }

        const newData = data.slice(lastIndex);
        if (newData.length === 0) {
          console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.");
          return;
        }

        const tx = db.transaction("trainees", "readwrite");
        const store = tx.objectStore("trainees");

        newData.forEach(row => {
  const newRecord = {
    datetime: row[0] || "",      // ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®
    course: row[1] || "",        // ğŸ“˜ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
    name: row[2] || "",          // ğŸ§‘â€ğŸ“ Ø§Ù„Ø§Ø³Ù…
    phone: row[3] || "",         // ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ
    startTime: row[4] || "",     // â° ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡
    timeTaken: row[5] || "",     // â³ Ø§Ù„Ù…Ø¯Ø©
    score: row[6] || "",         // ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    traineeCode: row[7] || ""    // ğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨
  };


          store.add(newRecord);
        });

        tx.oncomplete = () => {
          console.log("âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          localStorage.setItem("lastSyncedIndex", lastIndex + newData.length);
          loadLatestData?.();
        };
      })
      .catch(err => {
        console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets", err);
      });
  };
}


function openDB() {
  const request = indexedDB.open("TraineeQuizDBIlc", 1);

  request.onupgradeneeded = function (e) {
    db = e.target.result;
    if (!db.objectStoreNames.contains("trainees")) {
      db.createObjectStore("trainees", { keyPath: "id", autoIncrement: true });
    }
  };

 request.onsuccess = function (e) {
  db = e.target.result;

  // Ø£ÙˆÙ„ Ù…Ø±Ø©: Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù† Google Sheets Ø¥Ù„Ù‰ IndexedDB
  syncWithGoogleSheets();

  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ØªØ¹Ù…Ù„ Ù…Ù† IndexedDB Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  // Ù…ÙÙŠØ´ Ø¯Ø§Ø¹ÙŠ Ù†Ù†Ø§Ø¯ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø£Ù†Ù‡Ø§ Ù‡ØªØªÙ†Ø§Ø¯Ù‰ Ø¯Ø§Ø®Ù„ tx.oncomplete Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„
};




  request.onerror = function () {
    alert("ÙØ´Ù„ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  };
}

function loadDepartmentsFromEmailField() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const departments = new Set();

    allRecords.forEach(record => {
      if (record.email && record.email.trim() !== "") {
        departments.add(record.email.trim());
      }
    });

    const datalist = document.getElementById("departments");
    datalist.innerHTML = "";

    departments.forEach(dep => {
      const option = document.createElement("option");
      option.value = dep;
      datalist.appendChild(option);
    });
  };
}

function loadQualificationsFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const qualifications = new Set();

    allRecords.forEach(record => {
      if (record.qualification && record.qualification.trim() !== "") {
        qualifications.add(record.qualification.trim());
      }
    });

    const datalist = document.getElementById("qualifications");
    datalist.innerHTML = "";

    qualifications.forEach(q => {
      const option = document.createElement("option");
      option.value = q;
      datalist.appendChild(option);
    });
  };
}

function loadJobsFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const jobs = new Set();

    allRecords.forEach(record => {
      if (record.job && record.job.trim() !== "") {
        jobs.add(record.job.trim());
      }
    });

    const datalist = document.getElementById("jobs");
    datalist.innerHTML = "";

    jobs.forEach(job => {
      const option = document.createElement("option");
      option.value = job;
      datalist.appendChild(option);
    });
  };
}



function loadCoursesFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const courses = new Set();

    allRecords.forEach(record => {
      if (record.course && record.course.trim() !== "") {
        courses.add(record.course.trim());
      }
    });

    const datalist = document.getElementById("courses");
    datalist.innerHTML = "";

    courses.forEach(course => {
      const option = document.createElement("option");
      option.value = course;
      datalist.appendChild(option);
    });
  };
}


function loadNamesFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const names = new Set();

    allRecords.forEach(record => {
      if (record.name && record.name.trim() !== "") {
        names.add(record.name.trim());
      }
    });

    const datalist = document.getElementById("names");
    datalist.innerHTML = "";

    names.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      datalist.appendChild(option);
    });
  };
}


function loadPhonesFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const phones = new Set();

    allRecords.forEach(record => {
      if (record.phone && record.phone.trim() !== "") {
        phones.add(record.phone.trim());
      }
    });

    const datalist = document.getElementById("phones");
    datalist.innerHTML = "";

    phones.forEach(phone => {
      const option = document.createElement("option");
      option.value = phone;
      datalist.appendChild(option);
    });
  };
}




  function submitForm() {
    const now = new Date();
    const datetime = now.toLocaleString('ar-EG', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    const data = {
      name: document.getElementById("name").value,
      phone: document.getElementById("phone").value,
      email: document.getElementById("email").value,
      qualification: document.getElementById("qualification").value,
      job: document.getElementById("job").value,
      course: document.getElementById("course").value,
      duration: document.getElementById("duration").value,
      type: document.getElementById("type").value,
      datetime: datetime
    };

    document.getElementById("actionButtons").style.display = "flex";


    const tx = db.transaction("trainees", "readwrite");
    const store = tx.objectStore("trainees");
    const req = store.add(data);

    req.onsuccess = () => showData(data);
    req.onerror = () => alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
  }

 function showData(data) {
  document.getElementById("resName").innerText = data.name || "";
  document.getElementById("resPhone").innerText = data.phone || "";
  document.getElementById("resDepartment").innerText = data.department || "";
  document.getElementById("resQualification").innerText = data.qualification || "";
  document.getElementById("resJob").innerText = data.job || "";
  document.getElementById("resCourse").innerText = data.course || "";
  document.getElementById("resDuration").innerText = (data.courseStart || "") + " Ø¥Ù„Ù‰ " + (data.courseEnd || "");
  document.getElementById("resType").innerText = data.residency || "";
  document.getElementById("resDatetime").innerText = data.datetime || "";

  // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
  document.getElementById("resTrainerRating").innerText = data.trainerRating || "";
  document.getElementById("resContentRating").innerText = data.contentRating || "";
  document.getElementById("resOrganizationRating").innerText = data.organizationRating || "";
  document.getElementById("resResidencyRating").innerText = data.residencyRating || "";
  document.getElementById("resComments").innerText = data.comments || "";

  // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  document.getElementById("registrationForm").style.display = "none";
  document.getElementById("resultScreen").style.display = "block";
}




  function loadLatestData() {
    const tx = db.transaction("trainees", "readonly");
    const store = tx.objectStore("trainees");
    const req = store.openCursor(null, 'prev');

    req.onsuccess = e => {
      const cursor = e.target.result;
      if (cursor) {
        const d = cursor.value;
        document.getElementById("name").value = d.name;
        document.getElementById("phone").value = d.phone;
        document.getElementById("email").value = d.email;
        document.getElementById("qualification").value = d.qualification;
        document.getElementById("job").value = d.job;
        document.getElementById("course").value = d.course;
        document.getElementById("duration").value = d.duration;
        document.getElementById("type").value = d.type;
      }
    }
  }

  function exportToExcel() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");

  const headers = [
  "ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®",
  "ğŸ“˜ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©",
  "ğŸ§‘â€ğŸ“ Ø§Ù„Ø§Ø³Ù…",
  "ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ",
  "â° ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡",
  "â³ Ø§Ù„Ù…Ø¯Ø©",
  "ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©"
];

  const rows = [headers];
  const allData = [];

  store.openCursor().onsuccess = function (e) {
    const cursor = e.target.result;
    if (cursor) {
      const d = cursor.value;

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© "39 / 50"
      let score = 0;
      let total = 100;
      let percent = "";
      let grade = "";

      if (typeof d.score === "string" && d.score.includes("/")) {
        const parts = d.score.split("/").map(x => parseFloat(x.trim()));
        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
          score = parts[0];
          total = parts[1];

          const p = (score / total) * 100;
          percent = p.toFixed(1) + "%";

          if (p < 50) grade = "Ø±Ø§Ø³Ø¨";
          else if (p < 65) grade = "Ù…Ù‚Ø¨ÙˆÙ„";
          else if (p < 75) grade = "Ø¬ÙŠØ¯";
          else if (p < 85) grade = "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§";
          else grade = "Ø§Ù…ØªÙŠØ§Ø²";
        }
      }

      allData.push([
        d.datetime || "",
        d.name || "",
        d.phone || "",
        d.startTime || "",
        d.timeTaken || "",
        d.score || "",
        percent || "",
        grade || ""
      ]);

      cursor.continue();
    } else {
      const data = [...rows, ...allData];
      const ws = XLSX.utils.aoa_to_sheet(data);

      // ØªÙ†Ø³ÙŠÙ‚Ø§Øª
      const headerStyle = {
        font: { bold: true, sz: 14, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "4F81BD" } },
        alignment: { horizontal: "center", vertical: "center" },
        border: {
          top: { style: "thin", color: { auto: 1 } },
          bottom: { style: "thin", color: { auto: 1 } },
          left: { style: "thin", color: { auto: 1 } },
          right: { style: "thin", color: { auto: 1 } }
        }
      };

      const dataStyle = {
        font: { sz: 12 },
        alignment: { vertical: "center", wrapText: true },
        border: {
          top: { style: "thin", color: { auto: 1 } },
          bottom: { style: "thin", color: { auto: 1 } },
          left: { style: "thin", color: { auto: 1 } },
          right: { style: "thin", color: { auto: 1 } }
        }
      };

      const range = XLSX.utils.decode_range(ws["!ref"]);
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cell_address = { c: C, r: R };
          const cell_ref = XLSX.utils.encode_cell(cell_address);
          if (!ws[cell_ref]) continue;
          ws[cell_ref].s = (R === 0) ? headerStyle : dataStyle;
        }
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      const colWidths = data[0].map((col, i) => {
        let maxLen = col.length;
        allData.forEach(row => {
          if (row[i] && row[i].length > maxLen) {
            maxLen = row[i].length;
          }
        });
        return { wch: Math.min(Math.max(maxLen + 4, 12), 40) };
      });
      ws['!cols'] = colWidths;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ù†ØªØ§Ø¦Ø¬ ICDL");
      XLSX.writeFile(wb, "ICDL_Results.xlsx");
    }
  };

  store.openCursor().onerror = function (e) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");
  };
}


  function refreshData() {
  const dbName = "TraineeQuizDBIlc";

  try {
    // Ù„Ùˆ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± db Ù†Ù‚ÙÙ„Ù‡Ø§
    if (typeof db !== "undefined" && db) {
      db.close();
    }
  } catch (e) {
    console.warn("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¢Ù†ØŒ Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ø­Ø°Ù Ù…Ø¨Ø§Ø´Ø±Ø©.");
  }

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù
  const deleteRequest = indexedDB.deleteDatabase(dbName);

  deleteRequest.onsuccess = function () {
    location.reload();
  };

  deleteRequest.onerror = function () {
    alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
  };

  deleteRequest.onblocked = function () {
    alert("âš ï¸ Ù…Ø§ Ø²Ø§Ù„Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙØªÙˆØ­Ø©â€¦ Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
  };
}


  function toggleAllTrainees() {
  const traineesTable = document.getElementById("traineesTable");

  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = traineesTable.innerHTML;

  // Ø­Ø°Ù ÙƒÙ„ Ø¹Ù†Ø§ÙˆÙŠÙ† h3 Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
  const h3s = tempDiv.querySelectorAll('h3');
  h3s.forEach(h3 => h3.remove());

  const tableHtml = tempDiv.innerHTML;

  // Ù‡Ù†Ø§ Ù†Ø¬ÙŠØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
  const statsBoxes = document.getElementById("statsBoxes");
  const statsHtml = statsBoxes ? statsBoxes.innerHTML : '';

  const printWindow = window.open('', '', 'width=900,height=600');

  const currentDate = new Date().toLocaleDateString('ar-EG', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  printWindow.document.write(`
    <html>
      <head>
        <title>Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</title>
        <style>
          body {
            font-family: 'Arial', sans-serif;
            direction: rtl;
            padding: 20px;
            background-color: #fff;
            color: #000;
          }
          header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
          }
          .logo-container {
            text-align: center;
          }
          .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: block;
            margin: 0 auto;
          }
          .logo-caption {
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
            text-align: center;
          }
          .header-info {
            flex-grow: 1;
            margin-right: 20px;
            text-align: center;
          }
          .center-title {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0 5px 0;
            border-bottom: 2px solid #000;
            display: inline-block;
            padding-bottom: 5px;
          }
          .date {
            font-size: 14px;
            color: #333;
            text-align: left;
            margin-top: 10px;
          }
          /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
          #statsBoxes {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
          }
          .stat-box {
            border: 2px solid #4F81BD;
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 16px;
            background-color: #e7f0ff;
            color: #2a4d8f;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }
          th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
          }
          th {
            background-color: #f2f2f2;
          }
          button {
            display: none;
          }
          .signature {
            text-align: left;
            margin-top: 50px;
            font-family: 'Brush Script MT', cursive;
            font-size: 24px;
            color: #444;
            padding-left: 40px;
          }
        </style>
      </head>
      <body>
        <header>
          <div class="logo-container">
            <img src="ilc.jpg" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" class="logo">
            <div class="logo-caption"> ILCTANTA </div>
          </div>
          <div class="header-info">
            <div class="center-title">Ø¬Ø¯ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</div>
          </div>
          <div class="date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${currentDate}</div>
        </header>

        <div id="statsBoxes">${statsHtml}</div>

        <div id="traineesTable">${tableHtml}</div>

      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();

  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 300);
}




function deleteRecord(id) {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
    const tx = db.transaction("trainees", "readwrite");
    const store = tx.objectStore("trainees");
    store.delete(id).onsuccess = () => {
      alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„.");
      searchTrainees() ;


    };
  }
}


function addNewTrainee() {
  document.getElementById("registrationForm").style.display = "block";
  document.getElementById("resultScreen").style.display = "none";
  document.getElementById("traineesTable").style.display = "none";
  document.getElementById("actionButtons").style.display = "none";

  // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¢Ø®Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
  document.getElementById("name").value = document.getElementById("resName").textContent;
  document.getElementById("phone").value = document.getElementById("resPhone").textContent;
  document.getElementById("email").value = document.getElementById("resEmail").textContent;
  document.getElementById("qualification").value = document.getElementById("resQualification").textContent;
  document.getElementById("job").value = document.getElementById("resJob").textContent;
  document.getElementById("course").value = document.getElementById("resCourse").textContent;
  document.getElementById("duration").value = document.getElementById("resDuration").textContent;
  document.getElementById("type").value = document.getElementById("resType").textContent;
}



// âœ… Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù‚ÙŠÙ…/Ø© ÙˆØ¥Ø¶Ø§ÙØ© ÙÙ„ØªØ±Ø© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
let showResults = false;

function extractDateRangeFromText(text) {
  const monthNames = {
    "ÙŠÙ†Ø§ÙŠØ±": 0, "ÙØ¨Ø±Ø§ÙŠØ±": 1, "Ù…Ø§Ø±Ø³": 2, "Ø£Ø¨Ø±ÙŠÙ„": 3, "Ø§Ø¨Ø±ÙŠÙ„": 3,
    "Ù…Ø§ÙŠÙˆ": 4, "ÙŠÙˆÙ†ÙŠÙˆ": 5, "ÙŠÙˆÙ„ÙŠÙˆ": 6, "Ø£ØºØ³Ø·Ø³": 7, "Ø§ØºØ³Ø·Ø³": 7,
    "Ø³Ø¨ØªÙ…Ø¨Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ø±": 9, "Ø§ÙƒØªÙˆØ¨Ø±": 9,
    "Ù†ÙˆÙÙ…Ø¨Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ø±": 11
  };

  // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ
  text = text.replace(/Ø§Ù„Ù‰|Ø¥Ù„Ù‰/g, "Ø§Ù„Ù‰")
             .replace(/Ø§ÙƒØªÙˆØ¨Ø±/g, "Ø£ÙƒØªÙˆØ¨Ø±")
             .replace(/Ø§Ø¨Ø±ÙŠÙ„/g, "Ø£Ø¨Ø±ÙŠÙ„")
             .replace(/ +/g, " ").trim()
             .replace(/([^\s])Ø§Ù„Ù‰/, "$1 Ø§Ù„Ù‰")
             .replace(/Ø´Ù‡Ø±ÙŠÙ†/g, "2 Ø´Ù‡Ø±");

  // Ù†Ù…Ø·: Ù…Ù† ÙŠÙˆÙ†ÙŠÙˆ 2025 Ù„Ù…Ø¯Ø© 2 Ø´Ù‡Ø±
  const altMatch = text.match(/Ù…Ù†\s+(\w+)\s+(\d{4})\s+Ù„Ù…Ø¯Ø©\s+(\d+)/);
  if (altMatch) {
    const monthName = altMatch[1];
    const year = parseInt(altMatch[2]);
    const duration = parseInt(altMatch[3]);
    const fromMonth = monthNames[monthName];
    if (!isNaN(fromMonth)) {
      return {
        from: new Date(year, fromMonth, 1),
        to: new Date(year, fromMonth + duration, 0)
      };
    }
  }

  // Ù†Ù…Ø·: Ù…Ù† ÙŠÙˆÙ†ÙŠÙˆ Ø§Ù„Ù‰ Ø£ØºØ³Ø·Ø³ 2025
  const match = text.match(/Ù…Ù†\s+(\w+)\s+Ø§Ù„Ù‰\s+(\w+)\s+(\d{4})/);
  if (match) {
    const fromMonth = monthNames[match[1]];
    const toMonth = monthNames[match[2]];
    const year = parseInt(match[3]);
    if (!isNaN(fromMonth) && !isNaN(toMonth)) {
      return {
        from: new Date(year, fromMonth, 1),
        to: new Date(year, toMonth + 1, 0)
      };
    }
  }

  return null;
}




const gradeTranslation = {
  "Ø±Ø§Ø³Ø¨": "Fail",
  "Ù…Ù‚Ø¨ÙˆÙ„": "Pass",
  "Ø¬ÙŠØ¯": "Good",
  "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§": "Very Good",
  "Ø§Ù…ØªÙŠØ§Ø²": "Excellent"
};



function searchTrainees() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  const tbody = document.querySelector("#allTrainees tbody");
  const tableContainer = document.getElementById("traineesTable");

  if (!showResults) {
    tbody.innerHTML = "";
    showResults = true;
  } else {
    tbody.innerHTML = "";
    tableContainer.style.display = 'none';
    const oldStats = document.getElementById("statsInfo");
    if (oldStats) oldStats.remove();
    showResults = false;
    return;
  }

  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const allRecords = [];

  store.openCursor().onsuccess = function (e) {
    const cursor = e.target.result;
    if (cursor) {
      allRecords.push({ key: cursor.key, value: cursor.value });
      cursor.continue();
    } else {
      allRecords.sort((a, b) => new Date(b.value.datetime) - new Date(a.value.datetime));

      let count = 0;
      const stats = {
        byDate: {},
        byGrade: {
          "Ø±Ø§Ø³Ø¨": 0,
          "Ù…Ù‚Ø¨ÙˆÙ„": 0,
          "Ø¬ÙŠØ¯": 0,
          "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§": 0,
          "Ø§Ù…ØªÙŠØ§Ø²": 0
        },
        byTest: {}
      };

      allRecords.forEach(({ key, value: d }) => {
        const combined = Object.values(d).join(" ").toLowerCase();
        if (!query || combined.includes(query)) {
          count++;

const testName = d.course || "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

          const dateKey = d.datetime
            ? new Date(d.datetime).toLocaleDateString("ar-EG")
            : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
          stats.byDate[dateKey] = (stats.byDate[dateKey] || 0) + 1;

         let score = 0;
let total = 100;

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù…Ù† Ù†Øµ Ù…Ø«Ù„ "39 / 50"
if (typeof d.score === "string" && d.score.includes("/")) {
  const parts = d.score.split("/").map(x => parseFloat(x.trim()));
  if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
    score = parts[0];
    total = parts[1];
  }
}

let percent = null;
let grade = "";

if (!isNaN(score) && !isNaN(total) && total !== 0) {
  percent = (score / total) * 100;

  if (percent < 50) grade = "Ø±Ø§Ø³Ø¨";
  else if (percent < 65) grade = "Ù…Ù‚Ø¨ÙˆÙ„";
  else if (percent < 75) grade = "Ø¬ÙŠØ¯";
  else if (percent < 85) grade = "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§";
  else grade = "Ø§Ù…ØªÙŠØ§Ø²";

  stats.byGrade[grade] = (stats.byGrade[grade] || 0) + 1;

  if (!stats.byTest[testName]) stats.byTest[testName] = [];
  stats.byTest[testName].push({
    name: d.name,
    phone: d.phone || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
    percent: percent.toFixed(1),
    grade: grade
  });
}




          const row = document.createElement("tr");
const fields = ["datetime", "course", "name", "phone", "startTime", "timeTaken", "score", "traineeCode"];
     fields.forEach(field => {
  const cell = document.createElement("td");

  if (field === "datetime") {
    cell.textContent = d[field]
      ? new Date(d[field]).toLocaleDateString("en-GB", {
          year: "numeric", month: "long", day: "numeric"
        })
      : "";
  } else if (field === "course") {
    cell.innerHTML = `<strong style="font-size: 18px;">${d.course || "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</strong>`;
  } else if (field === "score") {
    let scoreText = d.score || "";
    if (typeof scoreText === "string" && scoreText.includes("/")) {
cell.innerHTML = `<strong style="font-size: 18px; color: #FF0000;">ğŸ¯ ${scoreText}</strong>`;
    } else {
      cell.textContent = scoreText;
    }
  } else if (field === "rating") {
    cell.textContent = d.rating || ""; // Ø§Ù„ØªÙ‚Ø¯ÙŠØ± ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ø±ÙŠØ²ÙŠÙ„Øª
  } else if (field === "traineeCode") {
    cell.textContent = d.traineeCode || ""; // ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨
  } else {
    cell.textContent = d[field] || "";
  }

  cell.contentEditable = "true";
  cell.dataset.key = key;
  cell.dataset.field = field;

  cell.addEventListener("blur", function () {
    const key = Number(this.dataset.key);
    const field = this.dataset.field;
    const newValue = this.textContent.trim();
    const txUpdate = db.transaction("trainees", "readwrite");
    const storeUpdate = txUpdate.objectStore("trainees");
    const getRequest = storeUpdate.get(key);

    getRequest.onsuccess = function () {
      const data = getRequest.result;
      if (data && field in data) {
        data[field] = newValue;
        const updateRequest = storeUpdate.put(data);
        updateRequest.onsuccess = () => console.log(`âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…ÙØªØ§Ø­ ${key}`);
        updateRequest.onerror = (event) => console.error("âŒ ØªØ­Ø¯ÙŠØ« ÙØ´Ù„:", event.target.error);
      }
    };
  });

  row.appendChild(cell);
});


          const deleteCell = document.createElement("td");
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
          deleteBtn.onclick = () => deleteRecord(key);
          deleteCell.appendChild(deleteBtn);
          row.appendChild(deleteCell);

          tbody.appendChild(row);
        }
      });

      if (count === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>`;
        tableContainer.style.display = 'none';
        return;
      }

      tableContainer.style.display = 'block';

      const statsDiv = document.createElement("div");
      statsDiv.id = "statsInfo";
      statsDiv.style.display = "flex";
      statsDiv.style.flexWrap = "nowrap";
      statsDiv.style.justifyContent = "space-between";
      statsDiv.style.width = "100%";
      statsDiv.style.gap = "16px";
      statsDiv.style.margin = "16px 0";
      statsDiv.style.direction = "rtl";

      const createCard = (title, icon, dataObj, bgColor, canvasId) => {
        const card = document.createElement("div");
        card.style.backgroundColor = bgColor;
        card.style.border = "2px solid #003366";
        card.style.borderRadius = "10px";
        card.style.padding = "14px";
        card.style.color = "#003366";
        card.style.width = "33%";
        card.style.maxHeight = "400px";
        card.style.overflowY = "auto";
        card.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.style.justifyContent = "flex-start";

        const header = document.createElement("div");
        header.textContent = `${icon} ${title}`;
        header.style.marginBottom = "10px";
        header.style.fontSize = "20px";
        header.style.backgroundColor = "#003366";
        header.style.color = "#fff";
        header.style.fontWeight = "bold";
        header.style.padding = "6px";
        header.style.borderRadius = "6px";

        const body = document.createElement("div");
        const totalCount = Object.values(dataObj).reduce((a, b) => a + b, 0);
       body.innerHTML = Object.entries(dataObj)
  .map(([k, v]) => {
    const percent = totalCount > 0 ? ((v / totalCount) * 100).toFixed(1) : 0;
    const translated = gradeTranslation[k] || k;
    return `${translated}: ${v} (${percent}%)`;
  }).join("<br>") || "No data available";

        body.style.fontWeight = "bold";
        body.style.fontSize = "18px";

        const canvas = document.createElement("canvas");
        canvas.id = canvasId;
        canvas.style.marginTop = "10px";
        canvas.style.maxHeight = "180px";
        canvas.style.alignSelf = "center";

        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(canvas);
        return card;
      };

      const createTestSummaryCard = (testData) => {
        const card = document.createElement("div");
        card.style.backgroundColor = "#f0f0f0";
        card.style.border = "2px solid #003366";
        card.style.borderRadius = "10px";
        card.style.padding = "14px";
        card.style.color = "#003366";
        card.style.width = "33%";
        card.style.maxHeight = "400px";
        card.style.overflowY = "auto";
        card.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
        card.style.fontSize = "16px";
        card.style.fontWeight = "bold";
        card.style.direction = "rtl";

        const header = document.createElement("div");
        header.textContent = "ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ ÙƒÙ„ Ø§Ø®ØªØ¨Ø§Ø±";
        header.style.backgroundColor = "#003366";
        header.style.color = "#fff";
        header.style.padding = "6px";
        header.style.marginBottom = "10px";
        header.style.fontSize = "20px";
        header.style.borderRadius = "6px";

        const body = document.createElement("div");
        body.innerHTML = Object.entries(testData).map(([test, users]) => {
const userLines = users.map(u => {
  const gradeEn = gradeTranslation[u.grade] || u.grade;
  return `ğŸ‘¤ ${u.name} ğŸ“ ${u.phone} - ${u.percent}% (${gradeEn})`;
}).join("<br>");

          return `<strong>ğŸ§ª ${test} (${users.length} Ù…Ø´Ø§Ø±Ùƒ):</strong><br>${userLines}`;
        }).join("<br><br>") || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";

        card.appendChild(header);
        card.appendChild(body);
        return card;
      };

      
      tableContainer.parentNode.insertBefore(statsDiv, tableContainer);

      const drawPieChart = (canvasId, chartData) => {
        const ctx = document.getElementById(canvasId).getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: chartData.labels,
            datasets: [{
              data: chartData.data,
              backgroundColor: chartData.colors,
              borderColor: "#fff",
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
              tooltip: { enabled: true }
            }
          }
        });
      };

      const prepareChartData = (obj) => {
        const labels = Object.keys(obj);
        const data = Object.values(obj);
        const colors = labels.map(() => `hsl(${Math.random() * 360}, 70%, 60%)`);
        return { labels, data, colors };
      };

      drawPieChart("chart_byDate", prepareChartData(stats.byDate));
      drawPieChart("chart_byGrade", prepareChartData(stats.byGrade));

      const offset = statsDiv.getBoundingClientRect().top + window.scrollY - 12;
      window.scrollTo({ top: offset, behavior: 'smooth' });
    }
  };
}



// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ù…Ù…ÙƒÙ† ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§)
function parseArabicDate(dateStr) {
  // ÙØ±Ø¶Ø§Ù‹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„Ø´ÙƒÙ„: ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø©
  // ØªØ­ØªØ§Ø¬ ØªØ­ÙˆÙŠÙ„Ù‡ Ù„ØªØ§Ø±ÙŠØ® JS Ø¹Ø§Ø¯ÙŠ
  // Ù…Ø«Ø§Ù„: "10/06/2025"
  if (!dateStr) return 0;
  const parts = dateStr.split("/");
  if (parts.length !== 3) return 0;
  const [day, month, year] = parts.map(Number);
  return new Date(year, month - 1, day).getTime();
}


function printResult() {
  const printContents = document.getElementById("resultScreen").innerHTML;
  const originalContents = document.body.innerHTML;

  document.body.innerHTML = printContents;
  window.print();
  document.body.innerHTML = originalContents;
  location.reload(); // ÙŠØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
}




function toggleForm() {
    var form = document.getElementById("registrationForm");
    if (form.style.display === "none" || form.style.display === "") {
      form.style.display = "block";
    } else {
      form.style.display = "none";
    }
  }


  function backupIndexedDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const allData = [];

  store.openCursor().onsuccess = function (e) {
    const cursor = e.target.result;
    if (cursor) {
      allData.push(cursor.value);
      cursor.continue();
    } else {
      const json = JSON.stringify(allData, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "trainees_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }
  };
}

function restoreIndexedDB(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);
      const tx = db.transaction("trainees", "readwrite");
      const store = tx.objectStore("trainees");

      data.forEach(item => {
        store.put(item);
      });

      tx.oncomplete = () => {
        alert("Database restored successfully.");
        location.reload();
      };
    } catch (err) {
      alert("Error restoring data. Make sure it's a valid JSON backup.");
      console.error(err);
    }
  };
  reader.readAsText(file);
}



function parseArabicDate(arabicDate) {
  if (!arabicDate) return new Date(0); // ØªØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ… Ø¬Ø¯Ù‹Ø§ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯

  try {
    // Ø­ÙˆÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    const westernDigits = arabicDate.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));

    // Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
    const dateTimeParts = westernDigits.split(" ÙÙŠ ");
    if (dateTimeParts.length !== 2) return new Date(0);

    const [dayMonthYear, timePart] = dateTimeParts;

    // ØªØ±Ø¬Ù… Ø§Ù„Ø´Ù‡Ø±
    const months = {
      "ÙŠÙ†Ø§ÙŠØ±": "01",
      "ÙØ¨Ø±Ø§ÙŠØ±": "02",
      "Ù…Ø§Ø±Ø³": "03",
      "Ø£Ø¨Ø±ÙŠÙ„": "04",
      "Ù…Ø§ÙŠÙˆ": "05",
      "ÙŠÙˆÙ†ÙŠÙˆ": "06",
      "ÙŠÙˆÙ„ÙŠÙˆ": "07",
      "Ø£ØºØ³Ø·Ø³": "08",
      "Ø³Ø¨ØªÙ…Ø¨Ø±": "09",
      "Ø£ÙƒØªÙˆØ¨Ø±": "10",
      "Ù†ÙˆÙÙ…Ø¨Ø±": "11",
      "Ø¯ÙŠØ³Ù…Ø¨Ø±": "12"
    };

    const dayMonthYearMatch = dayMonthYear.match(/(\d{1,2}) (\S+) (\d{4})/);
    if (!dayMonthYearMatch) return new Date(0);

    const day = dayMonthYearMatch[1].padStart(2, '0');
    const month = months[dayMonthYearMatch[2]] || "01";
    const year = dayMonthYearMatch[3];

    // Ø§Ù„ÙˆÙ‚Øª Ù Ù¡:Ù¤Ù©:Ù¥Ù¢ Øµ Ø£Ùˆ Ù…
    let time = timePart.trim();
    let isPM = time.includes("Ù…");
    let timeDigits = time.replace(/[^\d:]/g, "");
    let [hh, mm, ss] = timeDigits.split(":").map(v => parseInt(v));
    if (isPM && hh < 12) hh += 12;
    if (!isPM && hh === 12) hh = 0;

    const isoString = `${year}-${month}-${day}T${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;

    return new Date(isoString);
  } catch (e) {
    return new Date(0);
  }
}


function printStatsAndCharts() {
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø¸Ø§Ù‡Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  document.getElementById('traineesTable').style.display = 'block';
  
  // Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  setTimeout(() => {
    window.print();
  }, 300);
}




  window.onload = openDB;
</script>
</body>
</html>
