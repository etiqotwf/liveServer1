<!DOCTYPE html>
<html lang="ar">
<head>
<script src="xlsx.full.min.js"></script>
<script src="chart.js"></script>



  <meta charset="UTF-8">
  
  <title>نظام تسجيل المتدربين</title>
  <style>



    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      background-color: #f0f0f0;
      padding: 20px;
    }
    
    input, select, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .container {
  width: 90%; /* أو استخدم 100% إذا أردت أن يملأ الشاشة بالكامل */
  max-width: 100%; /* يمنع التقييد بعرض ثابت */
  margin: auto;
  background-color: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    #resultScreen, #traineesTable {
      display: none;
    }

    
#traineesTable {
  display: none;
  overflow-x: auto;
  max-width: 100%;
  white-space: nowrap;
}



    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: right;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>

   <!-- النموذج أو المحتوى الرئيسي -->
  <form id="container">
    <!-- محتويات النموذج -->
  </form>

  <script>
    // عند الضغط على أي مكان في الصفحة، أدخل وضع ملء الشاشة
    document.addEventListener("click", () => {
      const elem = document.documentElement; // أو document.getElementById("myForm")
      if (document.fullscreenElement) return; // لا تفعل شيء إذا كنا بالفعل في ملء الشاشة

      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
      }
    });
  </script>


  <div class="container">
   <style>
  h2 {
    text-align: center;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 5px 0;
    color: #004080;
  }

  h2:nth-child(4) {
    font-size: 1.8em;      /* أكبر حجم للعنوان الرابع */
    font-weight: bold;
    margin-top: 5px;
    color: #007acc;
  }
  
</style>



<div style="
  position: relative;
  text-align: center;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin-top: 10px;
  margin-bottom: 30px;
">

  <!-- ✅ الصورة الدائرية + كلمة DTC -->
  <div style="
    position: absolute;
    top: 10px;
    left: 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
  ">

    <!-- 🖼️ اللوجو الكبير -->
    <img src="logo.jpg" alt="الشعار" style="
      width: 120px; /* ✅ تم تكبير العرض */
      height: 120px; /* ✅ تم تكبير الارتفاع */
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 6px 14px rgba(0,0,0,0.3);
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    "
    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.35)'"
    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 6px 14px rgba(0,0,0,0.3)'"
    >

    <!-- 🌈 كلمة DTC أسفل اللوجو -->
    <div style="
      margin-top: 8px;
      font-size: 26px; /* ✅ تم تكبير الخط */
      font-weight: 900;
      background: linear-gradient(90deg, #ff00cc, #3333ff, #ff0000);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      user-select: none;
      letter-spacing: 1.5px;
      text-shadow: 0 0 10px rgba(255,255,255,0.3);
    ">
      DTC TANTA
    </div>

  </div>

</div>
<!-- 🪔 شعار ذهبي فرعوني لقسم التقييم والمتابعة -->
<div id="signature" style="
  position: fixed;
  bottom: 200px;
  right: 60px;
  display: inline-block;
  padding: 2px 7px;
  border: 3px solid #d4af37;
  border-radius: 40px;
  background: radial-gradient(circle at center, rgba(60, 45, 10, 0.9) 0%, rgba(0, 0, 0, 0.85) 100%);
box-shadow: 0 0 10px rgba(255, 215, 0, 0.3), inset 0 0 8px rgba(255, 255, 200, 0.1);
  font-family: 'Papyrus', 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 900;
  color: #d4af37;
  background-clip: padding-box;
  letter-spacing: 1.5px;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
background-image: linear-gradient( 90deg, #b8860b 0%, /* ذهبى داكن */ #daa520 20%, /* لمعة ذهبية */ #ffd700 50%, /* ذهب مشع */ #fff8dc 75%, /* بيج فاتح */ #ffec8b 90%, /* لمعة ذهبية لامعة جدًا */ #b8860b 100% /* رجوع للذهبي الداكن */ ); box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 223, 0, 0.4); border: 2px solid #b8860b; color: #4b2e05; font-weight: 800;  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 400%;
  animation: fadeInRight 2s ease-out, shimmer 25s infinite linear;
  opacity: 0.95;
  z-index: 9999;
  pointer-events: none;
  transition: opacity 1s ease;
  text-align: center;
">
  ✍️ قسم التقييم والمتابعة
</div>

<style>
@keyframes fadeInRight {
  0% { opacity: 0; transform: translateX(40px) scale(0.9); }
  100% { opacity: 0.95; transform: translateX(0) scale(1); }
}

@keyframes shimmer {
  0% { background-position: -400%; }
  100% { background-position: 400%; }
}
</style>




  <!-- العناوين الرئيسية -->
  <h2>وزارة الموارد المائية والرى</h2>
  <h2>الهيئة المصرية العامة لمشروعات الصرف</h2>
  <h2>مركز تدريب الصرف بطنطا</h2>
  <h2>نموذج إدارة قاعدة بيانات المتدربين</h2>
  <h2>🔹 Trainees Database Management Form </h2>
</div>




<style>


#toggleFormBtn {
  display: block;
  width: 60%;               /* تقليل العرض عن 100% */
  margin: 15px auto;        /* وسط الصفحة أفقياً */
  font-size: 20px;
  font-weight: bold;
  padding: 14px 28px;
  background-color: #004085;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transition: background-color 0.3s ease;
  text-align: center;
}

#toggleFormBtn:hover {
  background-color: #002752;
}


</style>



<div id="passwordModal" style="
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  /* لا تضف display:flex هنا */
">

  <div style="
    background: #ffffff;
    padding: 30px 40px;
    border-radius: 14px;
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
    text-align: center;
    width: 360px;
    max-width: 90%;
  ">
    <h3 style="
      margin-bottom: 22px;
      font-weight: 700;
      font-size: 24px;
      color: #222222;
      letter-spacing: 0.03em;
    ">
      Password Confirmation
    </h3>
    <input
      type="password"
      id="passwordInput"
      placeholder="Enter your password"
      style="
        width: 100%;
        padding: 14px 16px;
        font-size: 16px;
        border: 1.8px solid #ddd;
        border-radius: 10px;
        box-sizing: border-box;
        transition: border-color 0.3s ease;
        outline-offset: 2px;
      "
      onfocus="this.style.borderColor='#4a90e2'"
      onblur="this.style.borderColor='#ddd'"
    />
    <div style="margin-top: 28px; display: flex; justify-content: center; gap: 16px;">
      <button
        onclick="confirmPassword()"
        style="
          flex: 1;
          padding: 14px 0;
          font-size: 16px;
          font-weight: 600;
          background-color: #2979ff;
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 6px 14px rgba(41, 121, 255, 0.45);
          transition: background-color 0.3s ease, box-shadow 0.3s ease;
        "
        onmouseover="this.style.backgroundColor='#1565c0'; this.style.boxShadow='0 8px 20px rgba(21, 101, 192, 0.6)'"
        onmouseout="this.style.backgroundColor='#2979ff'; this.style.boxShadow='0 6px 14px rgba(41, 121, 255, 0.45)'"
      >
        Confirm
      </button>
      <button
        onclick="closePasswordModal()"
        style="
          flex: 1;
          padding: 14px 0;
          font-size: 16px;
          font-weight: 600;
          background-color: #f0f0f0;
          color: #555555;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          transition: background-color 0.3s ease;
        "
        onmouseover="this.style.backgroundColor='#d6d6d6'"
        onmouseout="this.style.backgroundColor='#f0f0f0'"
      >
        Cancel
      </button>
    </div>
  </div>
</div>


<style>
  .db-button {
    font-size: 18px;     /* حجم الخط فقط */
    font-weight: bold;   /* تخانة الخط */
    background-color: #b3cffc;
    color: #003366;
    border: 1px solid #000000;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    transition: 0.2s ease-in-out;
  }

  .db-button:hover {
    background-color: #cce0ff;
  }
</style>

<!-- الأزرار -->
<button class="db-button" onclick="backupIndexedDB()">🔄 Backup Database</button>
<button class="db-button" onclick="document.getElementById('restoreFile').click()">♻️ Restore Database</button>
<input type="file" id="restoreFile" style="display: none;" onchange="restoreIndexedDB(event)" accept=".json" />

<div class="btn-container">
  <button class="btn btn-submit" type="button" onclick="printStatsAndCharts()">
    <svg viewBox="0 0 24 24" >
      <path d="M5 13l4 4L19 7"/>
    </svg>
طباعة 📊 الاحصاء  </button>

  

  <button class="btn btn-clear" type="button" onclick="clearIndexedDB()">
    <svg viewBox="0 0 24 24">
      <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
    مسح البيانات
  </button>

  <button class="btn btn-export" onclick="exportToExcel()">
    <svg viewBox="0 0 24 24">
      <path d="M12 3v12m0 0l4-4m-4 4l-4-4M4 17h16"/>
    </svg>
    تصدير إلى Excel
  </button>

  <button class="btn btn-show" type="button" onclick="toggleAllTrainees()">
  <svg viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="3"/>
    <path d="M2 12a10 10 0 0 1 20 0 10 10 0 0 1-20 0z"/>
  </svg>🖨️ 
طباعة نتائج البحث </button>


<style>
@media print {
  body * {
    visibility: hidden !important;
  }

  #statsInfo, #statsInfo * {
    visibility: visible !important;
    font-weight: 900 !important; /* جعل الخط ثقيل جداً */
    color: #000 !important;
  }

  #statsInfo {
    position: absolute;
    top: 40px;
    right: 0;
    left: 0;
    margin: 0 auto;
    padding: 10px 15px;
    box-sizing: border-box;
    font-size: 16pt !important; /* تصغير الخط قليلاً */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
  }

  #statsInfo div {
    height: auto !important;
    overflow: visible !important;
    page-break-inside: avoid;
  }

  #statsInfo::before {
    content: "الإحصاءات التفصيلية للمتدربين";
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    text-align: center;
    font-weight: 900;
    font-size: 20pt; /* تصغير العنوان شوي */
    color: #000;
    margin-bottom: 8px;
    border-bottom: 3px solid #000;
    padding-bottom: 6px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: white;
    z-index: 9999;
  }

  #traineesTable,
  #allTrainees,
  #searchInput {
    display: none !important;
  }
}
</style>
<div style="
  text-align: center;
  margin: 25px 0;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
  font-family: 'Cairo', sans-serif;
">

  <!-- 🗓️ البحث بالمدة (يمين) -->
  <div style="display: flex; align-items: center; gap: 8px;">
    <input 
      type="date" 
      id="fromDate" 
      style="
        padding: 12px 15px; 
        font-size: 17px; 
        border: 2px solid #0d6efd; 
        border-radius: 10px; 
        outline: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
      "
      onfocus="this.style.borderColor='#6610f2'; this.style.boxShadow='0 0 12px rgba(102,16,242,0.4)'"
      onblur="this.style.borderColor='#0d6efd'; this.style.boxShadow='0 2px 8px rgba(13,110,253,0.15)'"
    >
    <span style="font-weight: bold; font-size: 18px;">🕓 إلى</span>
    <input 
      type="date" 
      id="toDate" 
      style="
        padding: 12px 15px; 
        font-size: 17px; 
        border: 2px solid #0d6efd; 
        border-radius: 10px; 
        outline: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
      "
      onfocus="this.style.borderColor='#6610f2'; this.style.boxShadow='0 0 12px rgba(102,16,242,0.4)'"
      onblur="this.style.borderColor='#0d6efd'; this.style.boxShadow='0 2px 8px rgba(13,110,253,0.15)'"
    >
  </div>

  <!-- 🔍 البحث الشامل -->
  <div style="display: flex; align-items: center;">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="ابحث بالاسم، الدورة، التاريخ، ..." 
      style="
        width: 340px; 
        padding: 13px 18px; 
        font-size: 18px; 
        border: 2px solid #0d6efd; 
        border-radius: 10px 0 0 10px; 
        outline: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
      "
      onfocus="this.style.borderColor='#6610f2'; this.style.boxShadow='0 0 12px rgba(102,16,242,0.4)'"
      onblur="this.style.borderColor='#0d6efd'; this.style.boxShadow='0 2px 8px rgba(13,110,253,0.15)'"
    >

    <button 
      onclick="searchTrainees()" 
      style="
        position: relative;
        padding: 13px 25px; 
        font-size: 18px; 
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        color: white; 
        border: none; 
        border-radius: 0 10px 10px 0; 
        cursor: pointer;
        font-weight: 700;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        overflow: hidden;
      "
      onmouseover="this.style.transform='scale(1.08)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.4)'"
      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.3)'"
    >
      <span id='searchEmoji' style='font-size:22px; animation: bounce 1.2s infinite ease-in-out;'>🔎</span>
      <span>بحث</span>
      <span style="
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.15);
        transform: skewX(-45deg);
        animation: shine 3s infinite;
      "></span>
    </button>
  </div>
</div>

<style>
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}

@keyframes shine {
  0% { left: -100%; }
  50% { left: 120%; }
  100% { left: 120%; }
}
</style>




        <style>


#registrationForm {
      font-size: 20px;
      font-weight: bold;
      direction: rtl;
    }

    #registrationForm label {
      display: block;
      margin-top: 10px;
    }

    #registrationForm input,
    #registrationForm select {
      font-size: 18px;
      font-weight: bold;
      padding: 8px;
      width: 100%;
      margin-bottom: 10px;
      box-sizing: border-box;
    }



  .btn-container {
    display: flex;
    justify-content: center; /* مركز الأزرار أفقياً */
    gap: 16px;
    margin-top: 20px;
    flex-wrap: wrap; /* لو الشاشة ضيقة تتكسر الأسطر */
  }

  .btn {
    font-size: 25px;
    padding: 12px 16px;
    border: 1px solid #555;
    border-radius: 6px;
    color: #222;
    background-color: #f8f9fa;
    cursor: pointer;
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    width: 130px;
    box-shadow: none;
    font-weight: 600;
    transition: background-color 0.3s ease, color 0.3s ease;
    user-select: none;
  }



  .btn:hover {
    background-color: #e2e6ea;
    color: #000;
  }
  .btn:active {
    background-color: #ced4da;
  }

  /* ألوان رسمية */
  .btn-submit {
    border-color: #1c3d5a;
    color: #1c3d5a;
    background-color: #dbe9f4;
  }
  .btn-submit:hover {
    background-color: #c4dbf2;
  }

  .btn-add {
    border-color: #375a7f;
    color: #375a7f;
    background-color: #d3e0eb;
  }
  .btn-add:hover {
    background-color: #bbd1e4;
  }

  .btn-clear {
    border-color: #8b1c1c;
    color: #8b1c1c;
    background-color: #f2dede;
  }
  .btn-clear:hover {
    background-color: #e4baba;
  }

  .btn-export {
    border-color: #3a5f7d;
    color: #3a5f7d;
    background-color: #d1dde6;
  }
  .btn-export:hover {
    background-color: #b9c9db;
  }

  .btn-show {
    border-color: #565656;
    color: #565656;
    background-color: #e9e9e9;
  }
  .btn-show:hover {
    background-color: #d6d6d6;
  }

  .btn svg {
    width: 28px;
    height: 28px;
    fill: currentColor;
  }
</style>





</div>


      </div>
    </form>

    <style>
  #resultScreen {
    font-size: 18px;       /* تكبير الخط داخل القسم بالكامل */
    font-weight: bold;     /* جعل الخط ثقيل */
    direction: rtl;        /* لتناسق النص العربي */
    font-family: "Arial", sans-serif;
    margin-top: 20px;
  }

  #resultScreen h3 {
    font-size: 20px;
    margin-bottom: 15px;
    color: #2c3e50;
  }

  #resultScreen table {
    width: 100%;
    border-collapse: collapse;
  }

  #resultScreen th,
  #resultScreen td {
    padding: 12px 16px;
    border: 1px solid #ccc;
    text-align: right;
    font-size: 22px;
  }

  #resultScreen th {
    background-color: #f4f6f8;
    color: #333;
  }
</style>







   <style>
  .buttons {
    display: flex;
    gap: 16px; /* المسافة بين الأزرار */
    justify-content: center;
    margin-top: 20px;
  }

  .buttons button {
    font-size: 18px;       /* تكبير حجم الخط */
    font-weight: bold;     /* جعل الخط ثقيل */
    padding: 12px 20px;
    border: 1px solid #555;
    border-radius: 6px;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .buttons button:hover {
    background-color: #e2e6ea;
  }
</style>




   

<style>
 #traineesTable {
  background-color: rgb(255, 255, 249); /* خلفية بلون فاتح */
  padding: 15px;                       /* مسافة داخلية */
  border-radius: 15px;                 /* حواف مدورة */
  border: 5px dotted #444;             /* الإطار المنقط */
}

  /* تنسيق الجدول داخل الديف عشان يطلع مرتب */
  #traineesTable table {
    width: 100%;
    border-collapse: collapse;
    font-size: 18px;         /* حجم الخط الكبير */
    font-weight: bold;       /* يجعل الخط ثقيل */
  }

  #traineesTable th, #traineesTable td {
    border: 2px solid #ccc;
    padding: 10px;
    text-align: center;
  }

  #traineesTable th {
    background-color: #e0d8c3; /* لون مغاير شوي مناسب مع البيج */
  }

 #traineesTable h3 {
    text-align: center;      /* يوسّط العنوان */
    font-weight: bold;       /* يجعل الخط ثقيل */
    text-decoration: underline; /* يضيف خط تحت العنوان */
    margin-bottom: 15px;     /* مساحة تحت العنوان */
    font-size: 28px;         /* حجم الخط الكبير */
  }

</style>



<div id="traineesTable">
<h3 style="
  font-weight: 900; 
  font-size: 18px; 
  color: #222; 
  display: flex; 
  align-items: center; 
  gap: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;           
  padding-top: 16px;    /* رفع أكثر */
">
  🖨️ ⬆️ <span>لطباعة الاحصاءات والرسوم البيانية CTRL+p</span>
</h3>
<h3 style="margin: 0; padding-top: 2px; padding-bottom: 0;">قائمة المتدربين المسجلين:</h3>
  <table id="allTrainees">
    <thead>
      <tr>
       <tr>
  <th>🕒 تاريخ ووقت التسجيل</th> <!-- "📅  والوقت" -->
<th>👤 الاسم</th>
<th>📞 الهاتف</th>
<th>📧 البريد الإلكتروني</th>
<th>🏢 الإدارة - الإقليم</th>
<th>🎓 المؤهل</th>
<th>💼 الوظيفة</th>
<th>🏨 الإقامة</th>
<th>📘 اسم الدورة</th>
<th>📅 بداية الدورة</th>
<th>📅 نهاية الدورة</th>
<th>🧑‍🏫 تقييم المدرب</th>     <!-- "🧑‍🏫 المدرب" -->
<th>📘 تقييم المحتوى</th>     <!-- "📖 المادة العلمية" -->
<th>🛠️ تقييم التنظيم</th>     <!-- "🏢 التنظيم" -->
<th>🏨 تقييم الإقامة</th>     <!-- "🏨 الإقامة" (مكررة في titles) -->
<th>📝 ملاحظات</th>
<th>🗑️ إجراء</th>

</tr>

    </thead>
    <tbody></tbody>
  </table>
</div>







  <script>
  let db;


function syncWithGoogleSheets() {
  const txCheck = db.transaction("trainees", "readonly");
  const storeCheck = txCheck.objectStore("trainees");

  const countRequest = storeCheck.count();

  countRequest.onsuccess = function () {
    const count = countRequest.result;

    // إذا فاضي → lastIndex = 0
    const lastIndex = (count === 0) ? 0 : (localStorage.getItem("lastSyncedIndex") || 0);

    fetch(`https://script.google.com/macros/s/AKfycbw5P1p8vgWYf40hBzsSSUhK8ykZWdumWd5GAUuRbsyl5ur8-qyS4_4xoYhCiFQ2PL7UuQ/exec?lastIndex=${lastIndex}`)
      .then(response => response.json())
      .then(data => {
        if (!Array.isArray(data)) {
          console.error("البيانات غير صالحة");
          return;
        }

        if (data.length === 0) {
          console.log("لا توجد بيانات جديدة.");
          return;
        }

        const tx = db.transaction("trainees", "readwrite");
        const store = tx.objectStore("trainees");

        data.forEach(row => {
          const newRecord = {
            datetime: row[0] || "",
            name: row[1] || "",
            phone: row[2] || "",
            email: row[3] || "",
            department: row[4] || "",
            qualification: row[5] || "",
            job: row[6] || "",
            residency: row[7] || "",
            course: row[8] || "",
            courseStart: row[9] || "",
            courseEnd: row[10] || "",
            trainerRating: row[11] || "",
            contentRating: row[12] || "",
            organizationRating: row[13] || "",
            residencyRating: row[14] || "",
            comments: row[15] || ""
          };

          store.add(newRecord);
        });

        tx.oncomplete = () => {
          console.log("✅ تمت مزامنة البيانات");

          // تحديث الـ lastSyncedIndex فقط لو مش صفر
          if (lastIndex !== 0) {
            const newLastIndex = parseInt(lastIndex) + data.length;
            localStorage.setItem("lastSyncedIndex", newLastIndex);
          } else {
            // أول مرة، نحفظ آخر رقم في Google Sheet كله
            localStorage.setItem("lastSyncedIndex", data.length);
          }

          // تحديث الواجهة
          loadDepartmentsFromEmailField();
          loadQualificationsFromDB();
          loadJobsFromDB();
          loadCoursesFromDB();
          loadLatestData();
          loadNamesFromDB();
          loadPhonesFromDB();
        };
      })
      .catch(err => {
        console.error("❌ فشل في جلب البيانات من Google Sheets", err);
      });
  };
}


function openDB() {
  const request = indexedDB.open("TraineeDB", 1);

  request.onupgradeneeded = function (e) {
    db = e.target.result;
    if (!db.objectStoreNames.contains("trainees")) {
      db.createObjectStore("trainees", { keyPath: "id", autoIncrement: true });
    }
  };

 request.onsuccess = function (e) {
  db = e.target.result;

  // أول مرة: مزامنة من Google Sheets إلى IndexedDB
  syncWithGoogleSheets();

  // باقي الوظائف تعمل من IndexedDB بعد المزامنة
  // مفيش داعي ننادي دوال التحميل مباشرة لأنها هتتنادى داخل tx.oncomplete بعد ما يتم التحميل
};




  request.onerror = function () {
    alert("فشل في فتح قاعدة البيانات");
  };
}

function loadDepartmentsFromEmailField() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const departments = new Set();

    allRecords.forEach(record => {
      if (record.email && record.email.trim() !== "") {
        departments.add(record.email.trim());
      }
    });

    const datalist = document.getElementById("departments");
    datalist.innerHTML = "";

    departments.forEach(dep => {
      const option = document.createElement("option");
      option.value = dep;
      datalist.appendChild(option);
    });
  };
}

function loadQualificationsFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const qualifications = new Set();

    allRecords.forEach(record => {
      if (record.qualification && record.qualification.trim() !== "") {
        qualifications.add(record.qualification.trim());
      }
    });

    const datalist = document.getElementById("qualifications");
    datalist.innerHTML = "";

    qualifications.forEach(q => {
      const option = document.createElement("option");
      option.value = q;
      datalist.appendChild(option);
    });
  };
}

function loadJobsFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const jobs = new Set();

    allRecords.forEach(record => {
      if (record.job && record.job.trim() !== "") {
        jobs.add(record.job.trim());
      }
    });

    const datalist = document.getElementById("jobs");
    datalist.innerHTML = "";

    jobs.forEach(job => {
      const option = document.createElement("option");
      option.value = job;
      datalist.appendChild(option);
    });
  };
}



function loadCoursesFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const courses = new Set();

    allRecords.forEach(record => {
      if (record.course && record.course.trim() !== "") {
        courses.add(record.course.trim());
      }
    });

    const datalist = document.getElementById("courses");
    datalist.innerHTML = "";

    courses.forEach(course => {
      const option = document.createElement("option");
      option.value = course;
      datalist.appendChild(option);
    });
  };
}


function loadNamesFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const names = new Set();

    allRecords.forEach(record => {
      if (record.name && record.name.trim() !== "") {
        names.add(record.name.trim());
      }
    });

    const datalist = document.getElementById("names");
    datalist.innerHTML = "";

    names.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      datalist.appendChild(option);
    });
  };
}


function loadPhonesFromDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const request = store.getAll();

  request.onsuccess = function () {
    const allRecords = request.result;
    const phones = new Set();

    allRecords.forEach(record => {
      if (record.phone && record.phone.trim() !== "") {
        phones.add(record.phone.trim());
      }
    });

    const datalist = document.getElementById("phones");
    datalist.innerHTML = "";

    phones.forEach(phone => {
      const option = document.createElement("option");
      option.value = phone;
      datalist.appendChild(option);
    });
  };
}




  function submitForm() {
    const now = new Date();
    const datetime = now.toLocaleString('ar-EG', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    const data = {
      name: document.getElementById("name").value,
      phone: document.getElementById("phone").value,
      email: document.getElementById("email").value,
      qualification: document.getElementById("qualification").value,
      job: document.getElementById("job").value,
      course: document.getElementById("course").value,
      duration: document.getElementById("duration").value,
      type: document.getElementById("type").value,
      datetime: datetime
    };

    document.getElementById("actionButtons").style.display = "flex";


    const tx = db.transaction("trainees", "readwrite");
    const store = tx.objectStore("trainees");
    const req = store.add(data);

    req.onsuccess = () => showData(data);
    req.onerror = () => alert("خطأ أثناء الحفظ");
  }

 function showData(data) {
  document.getElementById("resName").innerText = data.name || "";
  document.getElementById("resPhone").innerText = data.phone || "";
  document.getElementById("resDepartment").innerText = data.department || "";
  document.getElementById("resQualification").innerText = data.qualification || "";
  document.getElementById("resJob").innerText = data.job || "";
  document.getElementById("resCourse").innerText = data.course || "";
  document.getElementById("resDuration").innerText = (data.courseStart || "") + " إلى " + (data.courseEnd || "");
  document.getElementById("resType").innerText = data.residency || "";
  document.getElementById("resDatetime").innerText = data.datetime || "";

  // الحقول الإضافية الخاصة بالتقييمات
  document.getElementById("resTrainerRating").innerText = data.trainerRating || "";
  document.getElementById("resContentRating").innerText = data.contentRating || "";
  document.getElementById("resOrganizationRating").innerText = data.organizationRating || "";
  document.getElementById("resResidencyRating").innerText = data.residencyRating || "";
  document.getElementById("resComments").innerText = data.comments || "";

  // إظهار شاشة النتيجة وإخفاء نموذج التسجيل
  document.getElementById("registrationForm").style.display = "none";
  document.getElementById("resultScreen").style.display = "block";
}




  function loadLatestData() {
    const tx = db.transaction("trainees", "readonly");
    const store = tx.objectStore("trainees");
    const req = store.openCursor(null, 'prev');

    req.onsuccess = e => {
      const cursor = e.target.result;
      if (cursor) {
        const d = cursor.value;
        document.getElementById("name").value = d.name;
        document.getElementById("phone").value = d.phone;
        document.getElementById("email").value = d.email;
        document.getElementById("qualification").value = d.qualification;
        document.getElementById("job").value = d.job;
        document.getElementById("course").value = d.course;
        document.getElementById("duration").value = d.duration;
        document.getElementById("type").value = d.type;
      }
    }
  }

  function exportToExcel() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");

  const headers = [
    "🕒 تاريخ ووقت التسجيل",
    "👤 الاسم",
    "📞 الهاتف",
    "📧 البريد الإلكتروني",
    "🏢 الإدارة",
    "🎓 المؤهل",
    "💼 الوظيفة",
    "🏨 الإقامة",
    "📘 اسم الدورة",
    "📅 بداية الدورة",
    "📅 نهاية الدورة",
    "🧑‍🏫 تقييم المدرب",
    "📘 تقييم المحتوى",
    "🛠️ تقييم التنظيم",
    "🏨 تقييم الإقامة",
    "📝 ملاحظات"
  ];

  const rows = [headers];
  const allData = [];

  // 🧹 دالة تطبيع النص العربي
  function normalizeArabic(text) {
    if (!text) return "";
    return String(text)
      .replace(/[أإآا]/g, "ا")
      .replace(/ى/g, "ي")
      .replace(/ؤ/g, "و")
      .replace(/ئ/g, "ي")
      .replace(/ة/g, "ه")
      .toLowerCase();
  }

  store.openCursor().onsuccess = function (e) {
    const cursor = e.target.result;
    if (cursor) {
      const d = cursor.value;

      // 👇 إضافة الإقليم بجانب الإدارة
     // 👇 إضافة الإقليم بجانب الإدارة
if (d.department) {
  const originalDept = d.department.trim();
  const deptNorm = normalizeArabic(originalDept);
  let detectedRegion = "";

  const regionKeywords = {
    "إقليم صرف وسط الدلتا": ["طنطا","كفر الشيخ","الغربية","المنوفية","البحيرة","الدقهلية","الشرقية","زفتى","كفر الزيات","وسط الدلتا","مركز تدريب الصرف","مصنع مواسير زفتى"],
    "إقليم صرف غرب الدلتا": ["غرب الدلتا","غرب البحيرة","شمال البحيرة","جنوب شرق البحيرة","النصر","النوبارية","دمنهور","مشروعات صرف غرب الدلتا"],
    "إقليم صرف شرق الدلتا": ["دمياط","بطلخا","فاقوس","الزقازيق","القليوبية","الشرقية","المنصورة","شرق الدلتا","صرف دمياط بطلخا","ادارة دمياط بطلخا"],
    "إقليم صرف القناة وسيناء": ["الاسماعيلية","الإسماعيلية","بورسعيد","السويس","سيناء","القنطرة","التل الكبير","فايد","القناة"],
    "إقليم صرف مصر العليا": ["اسوان","سوهاج","اسيوط","الوادى الجديد","شمال قنا","جنوب قنا","كوم امبو","مشروعات صرف جنوب قنا باسنا"],
    "إقليم صرف مصر الوسطى": ["جنوب الفيوم","بنى سويف","شمال الجيزة","غرب الفيوم","شرق الفيوم","جنوب الجيزة"]
  };

  // 🧭 البحث عن الإقليم المناسب
  for (const [region, keywords] of Object.entries(regionKeywords)) {
    for (const kw of keywords) {
      const kwNorm = normalizeArabic(kw);
      if (deptNorm.includes(kwNorm)) {
        detectedRegion = region;
        break;
      }
    }
    if (detectedRegion) break;
  }

  // ✅ إضافة شرط خاص بالهيئة
  if (!detectedRegion && (deptNorm.includes("هيئه") || deptNorm.includes("هيئة"))) {
    detectedRegion = "المركز الرئيسي - الهيئة";
  }

  if (!detectedRegion) {
    if (deptNorm.includes("مصنع مواسير") || deptNorm.includes("مركز تدريب الصرف")) {
      detectedRegion = "إقليم صرف وسط الدلتا";
    }
  }

  // 🏷️ الدمج النهائي
  d.department = detectedRegion ? `${originalDept} - ${detectedRegion}` : originalDept;
}

      // 📝 إضافة الصفوف
      allData.push([
        d.datetime || "",
        d.name || "",
        d.phone || "",
        d.email || "",
        d.department || "",
        d.qualification || "",
        d.job || "",
        d.residency || "",
        d.course || "",
        d.courseStart || "",
        d.courseEnd || "",
        d.trainerRating || "",
        d.contentRating || "",
        d.organizationRating || "",
        d.residencyRating || "",
        d.comments || ""
      ]);

      cursor.continue();
    } else {
      const data = [...rows, ...allData];
      const ws = XLSX.utils.aoa_to_sheet(data);

      // إعدادات الخط والحجم والحدود
      const headerStyle = {
        font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "4F81BD" } },
        alignment: { horizontal: "center", vertical: "center" },
        border: {
          top: { style: "thin", color: { auto: 1 } },
          bottom: { style: "thin", color: { auto: 1 } },
          left: { style: "thin", color: { auto: 1 } },
          right: { style: "thin", color: { auto: 1 } }
        }
      };

      const dataStyle = {
        font: { sz: 16 },
        alignment: { vertical: "center", wrapText: true },
        border: {
          top: { style: "thin", color: { auto: 1 } },
          bottom: { style: "thin", color: { auto: 1 } },
          left: { style: "thin", color: { auto: 1 } },
          right: { style: "thin", color: { auto: 1 } }
        }
      };

      const range = XLSX.utils.decode_range(ws["!ref"]);
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cell_address = { c: C, r: R };
          const cell_ref = XLSX.utils.encode_cell(cell_address);
          if (!ws[cell_ref]) continue;
          ws[cell_ref].s = (R === 0) ? headerStyle : dataStyle;
        }
      }

      // ضبط عرض الأعمدة تلقائيًا
      const colWidths = data[0].map((col, i) => {
        let maxLen = col.length;
        allData.forEach(row => {
          if (row[i] && row[i].length > maxLen) maxLen = row[i].length;
        });
        return { wch: Math.min(Math.max(maxLen + 4, 12), 40) };
      });
      ws['!cols'] = colWidths;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "المتدربين");
      XLSX.writeFile(wb, "trainees.xlsx");
    }
  };

  store.openCursor().onerror = function(e) {
    alert("حدث خطأ أثناء تحميل البيانات للتصدير.");
  };
}


  function clearIndexedDB() {
  // فتح نافذة كلمة المرور
  document.getElementById("passwordModal").style.display = "flex";
}

function confirmPassword() {
  const input = document.getElementById("passwordInput").value;
  if (input === "1550") {
    const tx = db.transaction("trainees", "readwrite");
    tx.objectStore("trainees").clear().onsuccess = () => {
      alert("تم مسح البيانات.");
      location.reload();
    };
  } else {
    alert("كلمة المرور غير صحيحة.");
  }
  closePasswordModal();
}

function closePasswordModal() {
  document.getElementById("passwordModal").style.display = "none";
  document.getElementById("passwordInput").value = "";
}


  function toggleAllTrainees() {
  const traineesTable = document.getElementById("traineesTable");


  // ✳️ تعديل الإدارات داخل الجدول لإضافة الإقليم قبل الطباعة
const rows = traineesTable.querySelectorAll("tbody tr");
rows.forEach(row => {
  const deptCell = row.cells[4]; // العمود الخامس عادة هو عمود "الإدارة"
  if (deptCell && deptCell.textContent.trim()) {
    const deptName = deptCell.textContent.trim();
    if (regionsMap[deptName]) {
      deptCell.textContent = `${deptName} - ${regionsMap[deptName]}`;
    }
  }
});


  // إنشاء عنصر مؤقت لنسخ المحتوى
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = traineesTable.innerHTML;

  // حذف كل عناوين h3 داخل النسخة المؤقتة
  const h3s = tempDiv.querySelectorAll('h3');
  h3s.forEach(h3 => h3.remove());

  const tableHtml = tempDiv.innerHTML;

  // هنا نجيب محتوى البوكسات الإحصائية
  const statsBoxes = document.getElementById("statsBoxes");
  const statsHtml = statsBoxes ? statsBoxes.innerHTML : '';

  const printWindow = window.open('', '', 'width=900,height=600');

  const currentDate = new Date().toLocaleDateString('ar-EG', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  printWindow.document.write(`
    <html>
      <head>
        <title>طباعة جدول المتدربين</title>
        <style>
          body {
            font-family: 'Arial', sans-serif;
            direction: rtl;
            padding: 20px;
            background-color: #fff;
            color: #000;
          }
          header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
          }
          .logo-container {
            text-align: center;
          }
          .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: block;
            margin: 0 auto;
          }
          .logo-caption {
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
            text-align: center;
          }
          .header-info {
            flex-grow: 1;
            margin-right: 20px;
            text-align: center;
          }
          .center-title {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0 5px 0;
            border-bottom: 2px solid #000;
            display: inline-block;
            padding-bottom: 5px;
          }
          .date {
            font-size: 14px;
            color: #333;
            text-align: left;
            margin-top: 10px;
          }
          /* تنسيق البوكسات الإحصائية */
          #statsBoxes {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
          }
          .stat-box {
            border: 2px solid #4F81BD;
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 16px;
            background-color: #e7f0ff;
            color: #2a4d8f;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }
          th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
          }
          th {
            background-color: #f2f2f2;
          }
          button {
            display: none;
          }
          .signature {
            text-align: left;
            margin-top: 50px;
            font-family: 'Brush Script MT', cursive;
            font-size: 24px;
            color: #444;
            padding-left: 40px;
          }
        </style>
      </head>
      <body>
        <header>
          <div class="logo-container">
            <img src="logo.jpg" alt="الشعار" class="logo">
            <div class="logo-caption">مركز تدريب الصرف بطنطا</div>
          </div>
          <div class="header-info">
            <div class="center-title">جدول نتائج البحث للمتدربين</div>
          </div>
          <div class="date">تاريخ الطباعة: ${currentDate}</div>
        </header>

        <div id="statsBoxes">${statsHtml}</div>

        <div id="traineesTable">${tableHtml}</div>

      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();

  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 300);
}




function deleteRecord(id) {
  if (confirm("هل أنت متأكد أنك تريد حذف هذا السجل؟")) {
    const tx = db.transaction("trainees", "readwrite");
    const store = tx.objectStore("trainees");
    store.delete(id).onsuccess = () => {
      alert("تم حذف السجل.");
      searchTrainees() ;


    };
  }
}


function addNewTrainee() {
  document.getElementById("registrationForm").style.display = "block";
  document.getElementById("resultScreen").style.display = "none";
  document.getElementById("traineesTable").style.display = "none";
  document.getElementById("actionButtons").style.display = "none";

  // تعبئة حقول النموذج بآخر البيانات المدخلة
  document.getElementById("name").value = document.getElementById("resName").textContent;
  document.getElementById("phone").value = document.getElementById("resPhone").textContent;
  document.getElementById("email").value = document.getElementById("resEmail").textContent;
  document.getElementById("qualification").value = document.getElementById("resQualification").textContent;
  document.getElementById("job").value = document.getElementById("resJob").textContent;
  document.getElementById("course").value = document.getElementById("resCourse").textContent;
  document.getElementById("duration").value = document.getElementById("resDuration").textContent;
  document.getElementById("type").value = document.getElementById("resType").textContent;
}



// ✅ الكود بعد التعديل النهائي لمعالجة التاريخ بالإنجليزية وتمييز المقيم/ة وإضافة فلترة الفترة الزمنية بالنص داخل خانة البحث
let showResults = false;

function extractDateRangeFromText(text) {
  const monthNames = {
    "يناير": 0, "فبراير": 1, "مارس": 2, "أبريل": 3, "ابريل": 3,
    "مايو": 4, "يونيو": 5, "يوليو": 6, "أغسطس": 7, "اغسطس": 7,
    "سبتمبر": 8, "أكتوبر": 9, "اكتوبر": 9,
    "نوفمبر": 10, "ديسمبر": 11
  };

  // تطبيع النص
  text = text.replace(/الى|إلى/g, "الى")
             .replace(/اكتوبر/g, "أكتوبر")
             .replace(/ابريل/g, "أبريل")
             .replace(/ +/g, " ").trim()
             .replace(/([^\s])الى/, "$1 الى")
             .replace(/شهرين/g, "2 شهر");

  // نمط: من يونيو 2025 لمدة 2 شهر
  const altMatch = text.match(/من\s+(\w+)\s+(\d{4})\s+لمدة\s+(\d+)/);
  if (altMatch) {
    const monthName = altMatch[1];
    const year = parseInt(altMatch[2]);
    const duration = parseInt(altMatch[3]);
    const fromMonth = monthNames[monthName];
    if (!isNaN(fromMonth)) {
      return {
        from: new Date(year, fromMonth, 1),
        to: new Date(year, fromMonth + duration, 0)
      };
    }
  }

  // نمط: من يونيو الى أغسطس 2025
  const match = text.match(/من\s+(\w+)\s+الى\s+(\w+)\s+(\d{4})/);
  if (match) {
    const fromMonth = monthNames[match[1]];
    const toMonth = monthNames[match[2]];
    const year = parseInt(match[3]);
    if (!isNaN(fromMonth) && !isNaN(toMonth)) {
      return {
        from: new Date(year, fromMonth, 1),
        to: new Date(year, toMonth + 1, 0)
      };
    }
  }

  return null;
}




// 🗂️ خريطة الإدارات والأقاليم
const regionsMap = {
  // 🔹 إقليم صرف وسط الدلتا
  "الإدارة العامة لصرف كفر الشيخ": "إقليم صرف وسط الدلتا",
  "الإدارة العامة لصرف الغربية": "إقليم صرف وسط الدلتا",
  "الإدارة العامة لصرف المنوفية": "إقليم صرف وسط الدلتا",
  "الإدارة العامة لصرف البحيرة": "إقليم صرف وسط الدلتا",
  "الإدارة العامة لصرف الدقهلية": "إقليم صرف وسط الدلتا",
  "الإدارة العامة لصرف الشرقية": "إقليم صرف وسط الدلتا",
  "الإدارة العامة لصرف وسط الدلتا": "إقليم صرف وسط الدلتا",

  // 🔹 إقليم صرف غرب الدلتا
  "الإدارة العامة لصرف شمال البحيرة": "إقليم صرف غرب الدلتا",
  "الإدارة العامة لصرف جنوب شرق البحيرة": "إقليم صرف غرب الدلتا",
  "الإدارة العامة لصرف غرب البحيرة": "إقليم صرف غرب الدلتا",
  "الإدارة العامة لصرف النصر": "إقليم صرف غرب الدلتا",
  "الإدارة العامة لصرف النوبارية": "إقليم صرف غرب الدلتا",

  // 🔹 إقليم صرف القناة وسيناء
  "الإدارة العامة لصرف الإسماعيلية": "إقليم صرف القناة وسيناء",
  "الإدارة العامة لصرف بورسعيد": "إقليم صرف القناة وسيناء",
  "الإدارة العامة لصرف السويس": "إقليم صرف القناة وسيناء",

  // 🔹 إقليم صرف شرق الدلتا
  "الإدارة العامة لمشروعات شرق الدلتا": "إقليم صرف شرق الدلتا",
  "الإدارة العامة لصرف شمال الشرقية": "إقليم صرف شرق الدلتا",
  "الإدارة العامة لصرف جنوب الشرقية": "إقليم صرف شرق الدلتا",
  "الإدارة العامة للمعدات والمصانع الشرقية": "إقليم صرف شرق الدلتا",
  "الإدارة العامة لصرف جنوب الدقهلية": "إقليم صرف شرق الدلتا",
  "الإدارة العامة لصرف وسط الدقهلية": "إقليم صرف شرق الدلتا",
  "الإدارة العامة لصرف شمال الدقهلية": "إقليم صرف شرق الدلتا",
  "الإدارة العامة لصرف القليوبية": "إقليم صرف شرق الدلتا"
};




function searchTrainees() {

console.log("جارٍ تنفيذ البحث...");
  
  // ✅ إخفاء التوقيع عند الضغط على زر البحث
  const signature = document.getElementById("signature");
  if (signature) {
    signature.style.opacity = "0";
    setTimeout(() => signature.style.display = "none", 1000);
  }

 const query = document.getElementById('searchInput').value.trim().toLowerCase();
  const range = extractDateRangeFromText(query);

  // 🔍 إضافة حقول بحث بالمدة من واجهة المستخدم (في حالة إدخال مباشر من المستخدم)
const fromInput = document.getElementById("fromDate") ? document.getElementById("fromDate").value : "";
const toInput = document.getElementById("toDate") ? document.getElementById("toDate").value : "";

let fromDate = fromInput ? new Date(fromInput) : (range ? range.from : null);
let toDate = toInput ? new Date(toInput) : (range ? range.to : null);

if (fromDate && toDate && fromDate > toDate) {
  alert("⚠️ تاريخ البداية يجب أن يكون قبل تاريخ النهاية");
  return;
}


  // تحويل الشهور من العربي للإنجليزي داخل query
const arabicToEnglishMonths = {
  "يناير": "january", "فبراير": "february", "مارس": "march", "أبريل": "april", "ابريل": "april",
  "مايو": "may", "يونيو": "june", "يوليو": "july", "أغسطس": "august", "اغسطس": "august",
  "سبتمبر": "september", "أكتوبر": "october", "اكتوبر": "october",
  "نوفمبر": "november", "ديسمبر": "december"
};

let queryNormalized = query;
for (const [ar, en] of Object.entries(arabicToEnglishMonths)) {
  queryNormalized = queryNormalized.replace(new RegExp(ar, 'gi'), en);
}

// استخراج الشهر والسنة من queryNormalized
const monthNames = {
  "january": 0, "february": 1, "march": 2, "april": 3,
  "may": 4, "june": 5, "july": 6, "august": 7,
  "september": 8, "october": 9, "november": 10, "december": 11
};

const monthYearMatch = queryNormalized.match(/(january|february|march|april|may|june|july|august|september|october|november|december)\s+(\d{4})/);
let searchMonth = null, searchYear = null;

if (monthYearMatch) {
  const monthName = monthYearMatch[1];
  const year = parseInt(monthYearMatch[2]);
  if (monthNames.hasOwnProperty(monthName)) {
    searchMonth = monthNames[monthName];
    searchYear = year;
  }
}


  const tbody = document.querySelector("#allTrainees tbody");
  const tableContainer = document.getElementById("traineesTable");

  if (!showResults) {
    tbody.innerHTML = "";
    showResults = true;
  } else {
    tbody.innerHTML = "";
    tableContainer.style.display = 'none';
    const oldStats = document.getElementById("statsInfo");
    if (oldStats) oldStats.remove();
    showResults = false;
    return;
  }

  let count = 0;
  const stats = {
    byYear: {},
    byCourseDate: {},
    byMonthYear: {},
    byDepartment: {},
    byJob: {},
    byResidencyGender: {}
  };

  // 🧩 دالة لإزالة الهمزات وتطبيع النص العربى
  function normalizeArabic(text) {
    if (!text) return "";
    return String(text)
      .replace(/[أإآا]/g, "ا")   // توحيد أشكال الألف
      .replace(/ى/g, "ي")        // الألف المقصورة
      .replace(/ؤ/g, "و")        // همزة على واو
      .replace(/ئ/g, "ي")        // همزة على ياء
      .replace(/ة/g, "ه")        // التاء المربوطة لهاء (اختياري)
      .toLowerCase();
  }

  // هروب محارف الريجكس عشان البحث الآمن
  function escapeRegex(s) {
    return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const allRecords = [];

  store.openCursor().onsuccess = function (e) {
    const cursor = e.target.result;
    if (cursor) {
      allRecords.push({ key: cursor.key, value: cursor.value });
      cursor.continue();
    } else {
      allRecords.sort((a, b) => new Date(b.value.datetime) - new Date(a.value.datetime));

      const oldStats = document.getElementById("statsInfo");
      if (oldStats) oldStats.remove();

      allRecords.forEach(({ key, value: d }) => {

if (d.department) {
  const originalDept = d.department.trim();
  const deptNorm = normalizeArabic(originalDept);
  let detectedRegion = "";

  // 🧮 دالة حساب التشابه (Levenshtein)
  function levenshteinDistance(a, b) {
    const matrix = Array.from({ length: a.length + 1 }, (_, i) =>
      Array.from({ length: b.length + 1 }, (_, j) => (i === 0 ? j : j === 0 ? i : 0))
    );
    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost
        );
      }
    }
    return matrix[a.length][b.length];
  }

  function similarity(a, b) {
    const dist = levenshteinDistance(a, b);
    const maxLen = Math.max(a.length, b.length);
    return 1 - dist / maxLen;
  }

  // 🗺️ خريطة الكلمات المفتاحية
const regionKeywords = {
  // 🔹 إقليم صرف وسط الدلتا
  "إقليم صرف وسط الدلتا": [
    "طنطا", "كفر الشيخ", "كفرالشيخ", "الغربية", "المنوفية", "المنوفيه", "البحيرة",
    "الدقهلية", "الشرقية", "زفتى", "كفر الزيات", "زفتي", "وسط الدلتا",
    "مركز تدريب الصرف", "مصنع مواسير زفتى", "مخازن كفر الزيات"
  ],

  // 🔹 إقليم صرف غرب الدلتا
  "إقليم صرف غرب الدلتا": [
    "غرب الدلتا", "غرب البحيرة", "شمال البحيرة", "جنوب شرق البحيرة",
    "النصر", "النوبارية", "دمنهور", "مشروعات صرف غرب الدلتا"
  ],

  // 🔹 إقليم صرف شرق الدلتا
  "إقليم صرف شرق الدلتا": [
    "دمياط", "بطلخا", "فاقوس", "الزقازيق", "القليوبية", "الشرقية",
    "المنصورة", "شرق الدلتا", "صرف دمياط بطلخا", "ادارة دمياط بطلخا"
  ],

  // 🔹 إقليم صرف القناة وسيناء
  "إقليم صرف القناة وسيناء": [
    "الاسماعيلية", "الإسماعيلية", "بورسعيد", "السويس",
    "سيناء", "القنطرة", "التل الكبير", "فايد", "القناة"
  ],

  // 🔹 إقليم صرف مصر العليا
  "إقليم صرف مصر العليا": [
    "صرف اسوان", "مشروعات صرف جنوب قنا باسنا", "صرف سوهاج",
    "صرف اسيوط", "صرف الوادى الجديد", "صرف شمال قنا", "صرف كوم امبو"
  ],

  // 🔹 إقليم صرف مصر الوسطى
  "إقليم صرف مصر الوسطى": [
    "صرف جنوب الفيوم", "صرف بنى سويف", "صرف شمال الجيزة",
    "صرف غرب الفيوم", "صرف شرق الفيوم", "صرف جنوب الجيزة",
    "الجيزة", "مشروعات صرف الجيزة"
  ],

  // 🟢 المركز الرئيسي الهيئة
  "المركز الرئيسي الهيئة": [
    "هيئة", "الهيئة"
  ]
};



  const deptTokens = deptNorm.split(/\s+/).filter(Boolean);

  // 🔍 نبحث بتشابه 0.7 أو أكثر
  for (const [region, keywords] of Object.entries(regionKeywords)) {
    for (const kw of keywords) {
      const kwNorm = normalizeArabic(kw);
      for (const token of deptTokens) {
        const sim = similarity(token, kwNorm);
        if (deptNorm.includes(kwNorm) || sim >= 0.7) {
          detectedRegion = region;
          break;
        }
      }
      if (detectedRegion) break;
    }
    if (detectedRegion) break;
  }

  // ⚙️ معالجة خاصة لمركز التدريب أو مصنع المواسير بدون موقع
  if (!detectedRegion) {
    const hasFactory = deptNorm.includes("مصنع مواسير");
    const hasTrainingCenter = deptNorm.includes("مركز تدريب الصرف");
    if ((hasFactory || hasTrainingCenter) && !deptNorm.match(/(طنطا|زفتى|كفر|الزيات|الجيزه|دمياط|البحيره|الاسماعيلية)/)) {
      detectedRegion = "إقليم صرف وسط الدلتا";
    }
  }

  // ✅ الإضافة النهائية: لون أحمر فاتح ثقيل فقط
  if (detectedRegion && !originalDept.includes(detectedRegion)) {
    d.department = `${originalDept} - <span style="color: #ff1a1a; font-weight: 800;">${detectedRegion}</span>`;
  } else if (!detectedRegion) {
    console.warn("⚠️ لم يتم التعرف على الإقليم لهذا القسم:", originalDept);
  }
}


        // بناء النص الموحد بأمان (تجنب undefined)
        const combined = Object.values(d).map(v => v ? String(v) : '').join(" ").toLowerCase();
const recordDate = d.courseStart ? new Date(Date.parse(d.courseStart)) : null;
const inRange =
  (!fromDate || !toDate || (recordDate && recordDate >= fromDate && recordDate <= toDate)) &&
  (searchMonth === null || (recordDate && recordDate.getMonth() === searchMonth && recordDate.getFullYear() === searchYear));

        // تطبيع النصوص وإجراء البحث الدقيق بدون همزات
        const normalizedCombined = normalizeArabic(combined);
const normalizedQuery = normalizeArabic(query);

// لو مفيش استعلام، نعتبر كل السجلات
let matches = false;

if (!normalizedQuery) {
  matches = true;
} else {
  // نقسم الاستعلام على -
  const subQueries = normalizedQuery.split("-").map(s => s.trim()).filter(Boolean);

  // AND: كل شرط لازم يتحقق
  matches = subQueries.every(sub => {
    const escaped = escapeRegex(sub).replace(/\s+/g, '\\s+');
    const pattern = `(^|[^\\p{L}])${escaped}($|[^\\p{L}])`;
    try {
      const re = new RegExp(pattern, 'iu');
      return re.test(normalizedCombined);
    } catch (err) {
      const fallbackPattern = `(^|\\s)${escaped}($|\\s)`;
      const re2 = new RegExp(fallbackPattern, 'i');
      return re2.test(normalizedCombined);
    }
  });
}


        if (matches && inRange) {
          count++;

          // تأمين استخدام recordDate (لو مفيش تاريخ، نستخدم 'بدون تاريخ')
          const yearKey = recordDate ? String(recordDate.getFullYear()) : "بدون تاريخ";
          stats.byYear[yearKey] = (stats.byYear[yearKey] || 0) + 1;

          const formattedStart = d.courseStart ? new Date(d.courseStart).toLocaleDateString("en-GB") : "No Date";
          const courseDateKey = `${d.course || 'غير محددة'} (${formattedStart})`;
          stats.byCourseDate[courseDateKey] = (stats.byCourseDate[courseDateKey] || 0) + 1;

          const monthYear = recordDate ? recordDate.toLocaleString("en-GB", { month: "long", year: "numeric" }) : "بدون تاريخ";
          stats.byMonthYear[monthYear] = (stats.byMonthYear[monthYear] || 0) + 1;

// 🧹 تنظيف اسم الإدارة من أي أكواد HTML قبل إضافتها في الإحصائيات
const cleanDept = d.department ? d.department.replace(/<[^>]*>/g, '').trim() : "غير محددة";
// 🔁 بدل البحث في الإدارة، نبحث في الإقليم
let regionOnly = "";
const regionMatch = d.department.match(/<span[^>]*>([^<]+)<\/span>|-?\s*([^<]+إقليم\s+صرف[^\s<]*)/i);
if (regionMatch) {
  regionOnly = regionMatch[1] || regionMatch[2] || "غير محدد";
} else {
  regionOnly = "غير محدد";
}
stats.byDepartment[regionOnly.trim()] = (stats.byDepartment[regionOnly.trim()] || 0) + 1;
          stats.byJob[d.job || "غير محددة"] = (stats.byJob[d.job || "غير محددة"] || 0) + 1;

          let residencyLabel = "غير مقيم/ة";
          const residencyType = (d.residency || '').trim();
          const gender = (d.gender || '').trim();

          if (residencyType.includes("غير")) {
            residencyLabel = gender === "أنثى" ? "غير مقيمة" : "غير مقيم";
          } else {
            residencyLabel = gender === "أنثى" ? "مقيمة" : "مقيم";
          }

          stats.byResidencyGender[residencyLabel] = (stats.byResidencyGender[residencyLabel] || 0) + 1;

          const row = document.createElement("tr");
          const fields = ["datetime","name","phone","email","department","qualification","job","residency","course","courseStart","courseEnd","trainerRating","contentRating","organizationRating","residencyRating","comments"];

         fields.forEach(field => {
  const cell = document.createElement("td");
  if (["datetime", "courseStart", "courseEnd"].includes(field)) {
    const rawDate = d[field];
    cell.textContent = rawDate
      ? new Date(rawDate).toLocaleDateString("en-GB", { year: "numeric", month: "long", day: "numeric" })
      : "";
  } else if (field === "department") {
    // 👇 عرض الإقليم باللون الأحمر كـ HTML
    cell.innerHTML = d[field] || "";
  } else {
    cell.textContent = d[field] || "";
  }


  
            cell.contentEditable = "true";
            cell.dataset.key = key;
            cell.dataset.field = field;
            cell.addEventListener("blur", function () {
              const key = Number(this.dataset.key);
              const field = this.dataset.field;
              const newValue = this.textContent.trim();
              const txUpdate = db.transaction("trainees", "readwrite");
              const storeUpdate = txUpdate.objectStore("trainees");
              const getRequest = storeUpdate.get(key);
              getRequest.onsuccess = function () {
                const data = getRequest.result;
                if (data && field in data) {
                  data[field] = newValue;
                  const updateRequest = storeUpdate.put(data);
                  updateRequest.onsuccess = () => console.log(`✅ تم التحديث للمفتاح ${key}`);
                  updateRequest.onerror = (event) => console.error("❌ تحديث فشل:", event.target.error);
                }
              };
            });
            row.appendChild(cell);
          });

          const deleteCell = document.createElement("td");
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "🗑 حذف";
          deleteBtn.onclick = () => deleteRecord(key);
          deleteCell.appendChild(deleteBtn);
          row.appendChild(deleteCell);
          tbody.appendChild(row);
        }
      });

      if (count === 0) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">لا توجد نتائج مطابقة</td></tr>`;
        tableContainer.style.display = 'none';
        return;
      }

      // === إنشاء البطاقات والرسوم البيانية كما فى الأصل ===
      const statsDiv = document.createElement("div");
      statsDiv.id = "statsInfo";
      statsDiv.style.display = "flex";
      statsDiv.style.flexWrap = "nowrap";
      statsDiv.style.gap = "14px";
      statsDiv.style.margin = "10px 0";
      statsDiv.style.direction = "rtl";
      statsDiv.style.justifyContent = "space-between";

      const createCard = (title, icon, contentObj, bgColor, cardId) => {
        const card = document.createElement("div");
        card.style.backgroundColor = bgColor;
        card.style.border = "2px solid #003366";
        card.style.borderRadius = "10px";
        card.style.padding = "14px";
        card.style.color = "#003366";
        card.style.fontSize = "18px";
        card.style.textAlign = "center";
        card.style.width = "calc(100% / 6 - 12px)";
        card.style.height = "320px";
        card.style.overflowY = "auto";
        card.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.style.justifyContent = "flex-start";

        const header = document.createElement("div");
        header.textContent = `${icon} ${title}`;
        header.style.marginBottom = "10px";
        header.style.fontSize = "20px";
        header.style.backgroundColor = "#003366";
        header.style.color = "#ffffff";
        header.style.fontWeight = "bold";
        header.style.padding = "6px";
        header.style.borderRadius = "6px";

        const body = document.createElement("div");
        body.textContent = Object.entries(contentObj).map(([k, v]) => `${k}: ${v}`).join(" - ") || "لا توجد بيانات";
        body.style.fontWeight = "bold";
        body.style.fontSize = "18px";

        const canvas = document.createElement("canvas");
        canvas.id = `chart_${cardId}`;
        canvas.style.marginTop = "10px";
        canvas.style.maxHeight = "180px";
        canvas.style.maxWidth = "240px";
        canvas.style.alignSelf = "center";

        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(canvas);
        return card;
      };

      const prepareChartData = (obj) => {
        const labels = Object.keys(obj);
        const data = Object.values(obj);
        const colors = labels.map(() => `hsl(${Math.random() * 360}, 70%, 60%)`);
        return { labels, data, colors };
      };

    // ✅ كارت عدد السجلات حسب السنة
statsDiv.appendChild(createCard(
  "عدد السجلات حسب السنة", 
  "📅", 
  stats.byYear, 
  "rgba(76, 175, 80, 0.15)", 
  "year"
));

// ✅ كارت عدد المتدربين حسب الدورة وتاريخها (بدون بحث بالمدة)
const courseDateCard = createCard(
  "عدد المتدربين حسب الدورة وتاريخها", 
  "📘", 
  stats.byCourseDate, 
  "rgba(33, 150, 243, 0.15)", 
  "courseDate"
);
statsDiv.appendChild(courseDateCard);

// ✅ باقي الكروت
statsDiv.appendChild(createCard(
  "عدد المتدربين حسب الشهر والسنة", 
  "🗓️", 
  stats.byMonthYear, 
  "rgba(255, 152, 0, 0.15)", 
  "monthYear"
));

statsDiv.appendChild(createCard(
  "عدد المتدربين حسب الاقليم", 
  "🏢", 
  stats.byDepartment, 
  "rgba(0, 150, 136, 0.15)", 
  "department"
));

statsDiv.appendChild(createCard(
  "عدد المتدربين حسب الوظيفة", 
  "💼", 
  stats.byJob, 
  "rgba(156, 39, 176, 0.15)", 
  "job"
));

statsDiv.appendChild(createCard(
  "عدد المتدربين حسب الإقامة والنوع", 
  "🏠", 
  stats.byResidencyGender, 
  "rgba(244, 67, 54, 0.15)", 
  "residency"
));

      tableContainer.parentNode.insertBefore(statsDiv, tableContainer);
      tableContainer.style.display = 'block';

      const drawPieChart = (canvasId, chartData) => {
        const ctx = document.getElementById(canvasId).getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: chartData.labels,
            datasets: [{
              data: chartData.data,
              backgroundColor: chartData.colors,
              borderColor: "#fff",
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
              tooltip: { enabled: true }
            }
          }
        });
      };

      drawPieChart("chart_year", prepareChartData(stats.byYear));
      drawPieChart("chart_courseDate", prepareChartData(stats.byCourseDate));
      drawPieChart("chart_monthYear", prepareChartData(stats.byMonthYear));
      drawPieChart("chart_department", prepareChartData(stats.byDepartment));
      drawPieChart("chart_job", prepareChartData(stats.byJob));
      drawPieChart("chart_residency", prepareChartData(stats.byResidencyGender));

      const statsBox = document.getElementById("statsInfo");
      const offset = statsBox.getBoundingClientRect().top + window.scrollY - 12;
      window.scrollTo({ top: offset, behavior: 'smooth' });
    }
  };
}


// دالة مساعدة لتحويل التاريخ العربي (إذا عندك دالة خاصة ممكن تستخدمها)
function parseArabicDate(dateStr) {
  // فرضاً التاريخ بالشكل: يوم/شهر/سنة
  // تحتاج تحويله لتاريخ JS عادي
  // مثال: "10/06/2025"
  if (!dateStr) return 0;
  const parts = dateStr.split("/");
  if (parts.length !== 3) return 0;
  const [day, month, year] = parts.map(Number);
  return new Date(year, month - 1, day).getTime();
}


function printResult() {
  const printContents = document.getElementById("resultScreen").innerHTML;
  const originalContents = document.body.innerHTML;

  document.body.innerHTML = printContents;
  window.print();
  document.body.innerHTML = originalContents;
  location.reload(); // يعيد تحميل الصفحة بعد الطباعة
}




function toggleForm() {
    var form = document.getElementById("registrationForm");
    if (form.style.display === "none" || form.style.display === "") {
      form.style.display = "block";
    } else {
      form.style.display = "none";
    }
  }


  function backupIndexedDB() {
  const tx = db.transaction("trainees", "readonly");
  const store = tx.objectStore("trainees");
  const allData = [];

  store.openCursor().onsuccess = function (e) {
    const cursor = e.target.result;
    if (cursor) {
      allData.push(cursor.value);
      cursor.continue();
    } else {
      const json = JSON.stringify(allData, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "trainees_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }
  };
}

function restoreIndexedDB(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);
      const tx = db.transaction("trainees", "readwrite");
      const store = tx.objectStore("trainees");

      data.forEach(item => {
        store.put(item);
      });

      tx.oncomplete = () => {
        alert("Database restored successfully.");
        location.reload();
      };
    } catch (err) {
      alert("Error restoring data. Make sure it's a valid JSON backup.");
      console.error(err);
    }
  };
  reader.readAsText(file);
}



function parseArabicDate(arabicDate) {
  if (!arabicDate) return new Date(0); // تاريخ قديم جدًا لو مش موجود

  try {
    // حول الأرقام العربية إلى إنجليزية
    const westernDigits = arabicDate.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));

    // استخرج التاريخ والوقت
    const dateTimeParts = westernDigits.split(" في ");
    if (dateTimeParts.length !== 2) return new Date(0);

    const [dayMonthYear, timePart] = dateTimeParts;

    // ترجم الشهر
    const months = {
      "يناير": "01",
      "فبراير": "02",
      "مارس": "03",
      "أبريل": "04",
      "مايو": "05",
      "يونيو": "06",
      "يوليو": "07",
      "أغسطس": "08",
      "سبتمبر": "09",
      "أكتوبر": "10",
      "نوفمبر": "11",
      "ديسمبر": "12"
    };

    const dayMonthYearMatch = dayMonthYear.match(/(\d{1,2}) (\S+) (\d{4})/);
    if (!dayMonthYearMatch) return new Date(0);

    const day = dayMonthYearMatch[1].padStart(2, '0');
    const month = months[dayMonthYearMatch[2]] || "01";
    const year = dayMonthYearMatch[3];

    // الوقت ٠١:٤٩:٥٢ ص أو م
    let time = timePart.trim();
    let isPM = time.includes("م");
    let timeDigits = time.replace(/[^\d:]/g, "");
    let [hh, mm, ss] = timeDigits.split(":").map(v => parseInt(v));
    if (isPM && hh < 12) hh += 12;
    if (!isPM && hh === 12) hh = 0;

    const isoString = `${year}-${month}-${day}T${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;

    return new Date(isoString);
  } catch (e) {
    return new Date(0);
  }
}


function printStatsAndCharts() {
  // تأكد من أن قسم الإحصاءات ظاهر قبل الطباعة
  document.getElementById('traineesTable').style.display = 'block';
  
  // طباعة فقط القسم المطلوب
  setTimeout(() => {
    window.print();
  }, 300);
}




  window.onload = openDB;
</script>
</body>
</html>
